<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classificador de Mat√®ria</title>
    <!-- Tailwind CSS per a l'estil -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF per a generar informes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Estils personalitzats addicionals */
        .atom-button {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .atom-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .feedback-modal-content {
            min-height: 80px; /* Evita que la interf√≠cie salti en mostrar el feedback */
        }
        .correct-modal {
            background-color: #d1fae5; /* Green-100 */
            color: #065f46; /* Green-800 */
            border-left: 5px solid #10b981; /* Green-500 */
        }
        .incorrect-modal {
            background-color: #fee2e2; /* Red-100 */
            color: #991b1b; /* Red-800 */
             border-left: 5px solid #ef4444; /* Red-500 */
        }
        .atom-sphere {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: inline-block;
            border: 2px solid rgba(0,0,0,0.2);
        }
        .molecule-container, .atom-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            padding: 8px;
            border-radius: 12px;
            background-color: rgba(255, 255, 255, 0.7);
            min-width: 80px;
        }
        .recipient-item {
             display: inline-flex;
             vertical-align: middle;
        }
    </style>
</head>
<body class="bg-green-50 font-sans flex items-center justify-center min-h-screen">

    <div class="container mx-auto p-4 max-w-4xl bg-white rounded-2xl shadow-lg">

        <!-- CAP√áALERA -->
        <header class="flex flex-col sm:flex-row justify-between items-center p-4 border-b-2 border-gray-200">
            <h1 class="text-2xl md:text-3xl font-bold text-blue-800 mb-2 sm:mb-0">üåç Classificador de Mat√®ria</h1>
            <div class="flex items-center space-x-4">
                <div class="text-lg font-semibold">
                    Punts: <span id="score" class="bg-blue-600 text-white rounded-full px-3 py-1">0</span>
                </div>
                <button id="generate-report-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">
                    Genera Informe
                </button>
            </div>
        </header>

        <!-- SELECCI√ì DE NIVELL -->
        <div class="p-4 flex justify-center gap-4">
            <button id="level1-btn" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-teal-400 focus:ring-opacity-75 transition duration-300">Nivell 1: Classificador</button>
            <button id="level2-btn" class="bg-purple-500 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:ring-opacity-75 transition duration-300">Nivell 2: Constructor</button>
        </div>
        
        <hr/>
        <input type="text" id="student-name" placeholder="Escriu el teu nom per a l'informe" class="w-full p-2 mt-4 border rounded-md">


        <!-- CONTINGUT PRINCIPAL -->
        <main id="main-content" class="p-4 md:p-6">

            <!-- NIVELL 1: EL CLASSIFICADOR -->
            <div id="level1-container">
                <h2 class="text-xl font-semibold text-center text-gray-700 mb-4">Nivell 1: Classifica la Subst√†ncia</h2>
                <div id="l1-question-card" class="bg-gray-50 p-6 rounded-xl shadow-md text-center">
                    <p class="text-lg mb-2">Subst√†ncia a classificar:</p>
                    <h3 id="l1-substance-name" class="text-3xl font-bold text-gray-800 mb-6">--</h3>
                    
                    <!-- Pas 1 -->
                    <div id="l1-step1">
                        <p class="font-semibold mb-3">Pas 1: Es pot separar per m√®todes f√≠sics?</p>
                        <div class="flex justify-center gap-4">
                            <button data-answer="mescla" class="l1-step1-btn bg-yellow-500 text-white font-bold py-3 px-6 rounded-lg w-48 hover:bg-yellow-600 transition">S√≠ (Mescla)</button>
                            <button data-answer="pura" class="l1-step1-btn bg-green-500 text-white font-bold py-3 px-6 rounded-lg w-48 hover:bg-green-600 transition">No (Subst√†ncia pura)</button>
                        </div>
                    </div>
                    
                    <!-- Pas 2 -->
                    <div id="l1-step2" class="hidden mt-6">
                        <p class="font-semibold mb-3">Pas 2: Com est√† formada?</p>
                        <div id="l1-step2-pure-buttons" class="flex justify-center gap-4">
                            <button data-answer="element" class="l1-step2-btn bg-blue-500 text-white font-bold py-3 px-6 rounded-lg w-40 hover:bg-blue-600 transition">Element</button>
                            <button data-answer="compost" class="l1-step2-btn bg-red-500 text-white font-bold py-3 px-6 rounded-lg w-40 hover:bg-red-600 transition">Compost</button>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center mt-4 gap-4">
                    <button id="l1-hint-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition"> necessito una pista (-2 punts)</button>
                </div>

            </div>

            <!-- NIVELL 2: EL CONSTRUCTOR AT√íMIC -->
            <div id="level2-container" class="hidden">
                 <h2 class="text-xl font-semibold text-center text-gray-700 mb-4">Nivell 2: Construeix la Mat√®ria</h2>
                 <div class="bg-gray-50 p-6 rounded-xl shadow-md">
                    <p class="text-center text-lg mb-2">Objectiu:</p>
                    <h3 id="l2-goal" class="text-2xl font-bold text-gray-800 mb-6 text-center">--</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Paleta de components -->
                        <div>
                            <h4 class="font-semibold mb-3 text-center">Paleta de Components</h4>
                            <div id="l2-palette" class="grid grid-cols-2 lg:grid-cols-3 gap-3 items-center justify-center p-2 bg-gray-200 rounded-lg">
                                <!-- Components visuals es generaran aqu√≠ -->
                            </div>
                        </div>
                        <!-- Recipient de construcci√≥ -->
                        <div>
                            <h4 class="font-semibold mb-3 text-center">El teu Recipient</h4>
                            <div id="l2-recipient" class="bg-white border-2 border-dashed border-gray-400 rounded-lg min-h-[150px] p-3 flex flex-wrap gap-2 items-start">
                                <!-- Components afegits apareixeran aqu√≠ -->
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-center gap-4 mt-6">
                        <button id="l2-verify-btn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition w-40">Verifica</button>
                        <button id="l2-reset-btn" class="bg-gray-400 text-white font-bold py-3 px-8 rounded-lg hover:bg-gray-500 transition">Reinicia</button>
                    </div>
                 </div>
                 
                 <div class="flex justify-center mt-4 gap-4">
                    <button id="l2-hint-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition"> necessito una pista (-2 punts)</button>
                 </div>

            </div>

        </main>
    </div>

    <!-- Finestra Modal per a Feedback -->
    <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div id="feedback-modal-content" class="feedback-modal-content bg-white rounded-lg shadow-xl p-6 max-w-md w-full">
            <h3 id="modal-title" class="text-2xl font-bold mb-4">--</h3>
            <p id="modal-explanation" class="mb-6">--</p>
            <button id="modal-close-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 w-full">Tanca i continua</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Dades de l'aplicaci√≥
            let level1Questions = [
                { substance: "Oxigen (O‚ÇÇ)", type1: "pura", type2: "element", hint: "Est√† format per un √∫nic tipus d'√†tom, encara que vagin en parelles.", explanation: "L'Oxigen √©s una subst√†ncia pura i un element, ja que totes les seves part√≠cules estan fetes d'√†toms d'oxigen." },
                { substance: "Aigua (H‚ÇÇO)", type1: "pura", type2: "compost", hint: "Les seves mol√®cules tenen √†toms d'Hidrogen i d'Oxigen units.", explanation: "L'aigua √©s una subst√†ncia pura i un compost, perqu√® est√† formada per mol√®cules id√®ntiques (H‚ÇÇO), cadascuna amb √†toms diferents." },
                { substance: "Aigua amb sal", type1: "mescla", type2: "homog√®nia", hint: "Cont√© aigua i sal, i no es poden distingir a simple vista.", explanation: "√âs una mescla (d'aigua i sal) i √©s homog√®nia perqu√® els seus components no es distingeixen." },
                { substance: "Ferro (Fe)", type1: "pura", type2: "element", hint: "Busca'l a la taula peri√≤dica. Est√† format per un sol tipus d'√†tom.", explanation: "El Ferro √©s un element qu√≠mic. Totes les part√≠cules s√≥n √†toms de Ferro." },
                { substance: "Aire", type1: "mescla", type2: "homog√®nia", hint: "√âs una combinaci√≥ de gasos com Nitrogen, Oxigen, etc.", explanation: "L'aire √©s una mescla de gasos (Nitrogen, Oxigen...). Com que no distingim els components, √©s homog√®nia." },
                { substance: "Di√≤xid de Carboni (CO‚ÇÇ)", type1: "pura", type2: "compost", hint: "Les seves mol√®cules tenen √†toms de Carboni i d'Oxigen units.", explanation: "El CO‚ÇÇ √©s un compost, format per mol√®cules on s'uneixen un √†tom de Carboni i dos d'Oxigen." },
                { substance: "Sopa de fideus", type1: "mescla", type2: "heterog√®nia", hint: "Pots veure clarament el brou i els fideus per separat.", explanation: "√âs una mescla heterog√®nia. Es poden distingir clarament els seus components (brou, fideus, verdures...)." },
                { substance: "Bronze", type1: "mescla", type2: "homog√®nia", hint: "√âs un aliatge, una barreja s√≤lida de metalls (Coure i Estany).", explanation: "El bronze √©s una mescla homog√®nia (un aliatge) de Coure i Estany." },
                { substance: "Llet", type1: "mescla", type2: "heterog√®nia", hint: "Encara que sembli uniforme, les gotes de greix estan suspeses en aigua. √âs un col¬∑loide.", explanation: "La llet √©s una mescla heterog√®nia (un col¬∑loide) de greix, prote√Ønes i aigua." },
                { substance: "Infusi√≥", type1: "mescla", type2: "homog√®nia", hint: "√âs aigua amb subst√†ncies dissoltes de la planta. No pots distingir els components.", explanation: "Una infusi√≥ √©s una mescla homog√®nia, ja que les subst√†ncies de la planta s'han dissolt en l'aigua." },
                { substance: "Amon√≠ac (NH‚ÇÉ)", type1: "pura", type2: "compost", hint: "Les seves mol√®cules estan formades per √†toms de Nitrogen i Hidrogen units.", explanation: "L'amon√≠ac √©s un compost qu√≠mic format per mol√®cules id√®ntiques (NH‚ÇÉ)." },
                { substance: "Heli (He)", type1: "pura", type2: "element", hint: "√âs un gas noble. Els seus √†toms no s'uneixen entre ells.", explanation: "L'Heli √©s un element. Totes les seves part√≠cules s√≥n √†toms individuals d'Heli." },
                { substance: "Acer", type1: "mescla", type2: "homog√®nia", hint: "√âs una barreja de Ferro i Carboni. √âs un aliatge met√†l¬∑lic.", explanation: "L'acer √©s una mescla homog√®nia (un aliatge) principalment de Ferro i Carboni." },
                { substance: "Plata (Ag)", type1: "pura", type2: "element", hint: "√âs un metall preci√≥s que trobar√†s a la taula peri√≤dica.", explanation: "La plata √©s un element qu√≠mic. Totes les seves part√≠cules s√≥n √†toms de Plata." },
                { substance: "Nitrogen (N‚ÇÇ)", type1: "pura", type2: "element", hint: "√âs el gas m√©s abundant de l'aire. Les seves part√≠cules estan formades per dos √†toms iguals.", explanation: "El Nitrogen √©s un element, ja que totes les seves part√≠cules estan fetes d'√†toms de nitrogen, agrupats en mol√®cules diat√≤miques (N‚ÇÇ)." }
            ];
            
            const masterPalette = [
                { id: 'He', type: 'atom', isElement: true, displayName: "√Ätom d'Heli", atoms: [{ color: 'bg-pink-400' }] },
                { id: 'Fe', type: 'atom', isElement: true, displayName: "√Ätom de Ferro", atoms: [{ color: 'bg-gray-500' }] },
                { id: 'O2', type: 'molecule', isElement: true, displayName: "Mol√®cula d'Oxigen", atoms: [{ color: 'bg-blue-500' }, { color: 'bg-blue-500' }] },
                { id: 'N2', type: 'molecule', isElement: true, displayName: "Mol√®cula de Nitrogen", atoms: [{ color: 'bg-purple-400' }, { color: 'bg-purple-400' }] },
                { id: 'H2O', type: 'molecule', isElement: false, displayName: "Mol√®cula d'Aigua", atoms: [{ color: 'bg-gray-200' }, { color: 'bg-blue-500' }, { color: 'bg-gray-200' }] },
                { id: 'CO2', type: 'molecule', isElement: false, displayName: "Mol√®cula de CO‚ÇÇ", atoms: [{ color: 'bg-gray-700' }, { color: 'bg-red-500' }, { color: 'bg-red-500' }] }
            ];

            const level2Challenges = [
                {
                    goal: "Construeix una subst√†ncia pura (Element monoat√≤mic)",
                    validation: (items) => {
                        if (items.length === 0) return false;
                        const firstItem = items[0];
                        const allSame = items.every(item => item.id === firstItem.id);
                        return allSame && firstItem.isElement && firstItem.type === 'atom';
                    },
                    hint: "Una subst√†ncia pura elemental est√† formada per un sol tipus d'√†tom. Afegeix diverses vegades la mateixa esfera que representa un √†tom sol.",
                    explanation: "Molt b√©! Una subst√†ncia pura elemental (monoat√≤mica) est√† formada per un √∫nic tipus d'√†tom, com l'Heli o el Ferro."
                },
                {
                    goal: "Construeix una subst√†ncia pura (Compost)",
                    validation: (items) => {
                        if (items.length === 0) return false;
                        const firstItem = items[0];
                        const allSame = items.every(item => item.id === firstItem.id);
                        return allSame && !firstItem.isElement;
                    },
                    hint: "Una subst√†ncia pura composta est√† formada per mol√®cules id√®ntiques. Afegeix diverses vegades la mateixa agrupaci√≥ d'esferes de colors.",
                    explanation: "Perfecte! Una subst√†ncia pura composta est√† formada per un sol tipus de mol√®cula, com l'aigua (H‚ÇÇO) o el CO‚ÇÇ."
                },
                {
                    goal: "Construeix una subst√†ncia pura (Element diat√≤mic)",
                    validation: (items) => {
                        if (items.length === 0) return false;
                        const firstItem = items[0];
                        const allSame = items.every(item => item.id === firstItem.id);
                        return allSame && firstItem.isElement && firstItem.type === 'molecule';
                    },
                    hint: "Alguns elements, com l'oxigen, formen mol√®cules de dos √†toms iguals. Totes les part√≠cules han de ser id√®ntiques.",
                    explanation: "Excel¬∑lent! L'oxigen o el nitrogen s√≥n elements, per√≤ les seves part√≠cules s√≥n mol√®cules diat√≤miques. Com que totes les part√≠cules s√≥n iguals, √©s una subst√†ncia pura."
                },
                {
                    goal: "Construeix una mescla de dos elements diat√≤mics",
                     validation: (items) => {
                        const uniqueIds = new Set(items.map(item => item.id));
                        if (uniqueIds.size !== 2) return false;
                        return uniqueIds.has('O2') && uniqueIds.has('N2');
                    },
                    hint: "Una mescla d'elements diat√≤mics cont√© mol√®cules de diferents elements, on cada mol√®cula est√† formada per dos √†toms iguals. Tria els dos tipus de mol√®cules diat√≤miques de la paleta.",
                    explanation: "Correcte! Has barrejat mol√®cules de dos elements diat√≤mics diferents, com l'Oxigen (O‚ÇÇ) i el Nitrogen (N‚ÇÇ)."
                },
                {
                    goal: "Construeix una mescla d'un element i un compost",
                    validation: (items) => {
                         const uniqueIds = new Set(items.map(item => item.id));
                        if (uniqueIds.size !== 2) return false;
                        const firstType = masterPalette.find(p => p.id === Array.from(uniqueIds)[0]);
                        const secondType = masterPalette.find(p => p.id === Array.from(uniqueIds)[1]);
                        return (firstType.isElement && !secondType.isElement) || (!firstType.isElement && secondType.isElement);
                    },
                    hint: "Barreja part√≠cules d'un element (√†toms o mol√®cules diat√≤miques) amb les part√≠cules d'un compost.",
                    explanation: "Molt b√©! Has barrejat les part√≠cules d'un element amb les d'un compost."
                },
                 {
                    goal: "Repte Especial: Construeix AIRE",
                    validation: (items) => {
                        const uniqueIds = new Set(items.map(item => item.id));
                        if (uniqueIds.size !== 2) return false;
                        
                        const hasN2 = items.some(item => item.id === 'N2');
                        const hasO2 = items.some(item => item.id === 'O2');
                        
                        return hasN2 && hasO2;
                    },
                    hint: "L'aire √©s una mescla principalment de dos gasos. Tots dos s√≥n elements diat√≤mics. El m√©s abundant √©s el Nitrogen.",
                    explanation: "Fant√†stic! Has representat l'aire, que √©s una mescla principalment de Nitrogen (N‚ÇÇ, ~78%) i Oxigen (O‚ÇÇ, ~21%)."
                }
            ];
            
            // Estat de l'aplicaci√≥
            let currentLevel = 1;
            let score = 0;
            let l1_currentQuestionIndex = 0;
            let l2_currentChallengeIndex = 0;
            let l2_recipientItems = [];
            let reportData = [];

            // Elements del DOM
            const scoreEl = document.getElementById('score');
            const level1Container = document.getElementById('level1-container');
            const level2Container = document.getElementById('level2-container');
            const l1_substanceNameEl = document.getElementById('l1-substance-name');
            const l1_step1El = document.getElementById('l1-step1');
            const l1_step2El = document.getElementById('l1-step2');
            const l1_hintBtn = document.getElementById('l1-hint-btn');
            const l2_goalEl = document.getElementById('l2-goal');
            const l2_paletteEl = document.getElementById('l2-palette');
            const l2_recipientEl = document.getElementById('l2-recipient');
            const l2_verifyBtn = document.getElementById('l2-verify-btn');
            const l2_resetBtn = document.getElementById('l2-reset-btn');
            const l2_hintBtn = document.getElementById('l2-hint-btn');
            const modalEl = document.getElementById('feedback-modal');
            const modalContentEl = document.getElementById('feedback-modal-content');
            const modalTitleEl = document.getElementById('modal-title');
            const modalExplanationEl = document.getElementById('modal-explanation');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            // Inicialitzaci√≥
            init();

            function init() {
                level1Questions.sort(() => Math.random() - 0.5);
                level2Challenges.sort(() => Math.random() - 0.5);

                document.getElementById('level1-btn').addEventListener('click', () => switchLevel(1));
                document.getElementById('level2-btn').addEventListener('click', () => switchLevel(2));
                
                l1_hintBtn.addEventListener('click', showLevel1Hint);
                l2_verifyBtn.addEventListener('click', verifyLevel2);
                l2_resetBtn.addEventListener('click', resetLevel2Recipient);
                l2_hintBtn.addEventListener('click', showLevel2Hint);
                document.getElementById('generate-report-btn').addEventListener('click', generateReport);
                modalCloseBtn.addEventListener('click', closeModal);
                modalEl.addEventListener('click', (e) => {
                    if (e.target === modalEl) closeModal();
                });

                document.querySelectorAll('.l1-step1-btn').forEach(btn => btn.addEventListener('click', handleL1Step1));
                document.querySelectorAll('.l1-step2-btn').forEach(btn => btn.addEventListener('click', handleL1Step2));

                switchLevel(1);
            }
            
            function switchLevel(level) {
                currentLevel = level;
                if (level === 1) {
                    level1Container.classList.remove('hidden');
                    level2Container.classList.add('hidden');
                    document.getElementById('level1-btn').classList.add('bg-teal-700', 'ring-2');
                    document.getElementById('level2-btn').classList.remove('bg-purple-700', 'ring-2');
                    loadLevel1Question();
                } else {
                    level1Container.classList.add('hidden');
                    level2Container.classList.remove('hidden');
                    document.getElementById('level1-btn').classList.remove('bg-teal-700', 'ring-2');
                    document.getElementById('level2-btn').classList.add('bg-purple-700', 'ring-2');
                    loadLevel2Challenge();
                }
            }

            function updateScore(points) {
                score += points;
                scoreEl.textContent = score;
            }

            // --- L√íGICA MODAL ---
            function showModal(title, explanation, isCorrect) {
                modalTitleEl.textContent = title;
                modalExplanationEl.textContent = explanation;
                modalContentEl.className = 'feedback-modal-content bg-white rounded-lg shadow-xl p-6 max-w-md w-full'; // Reset
                if (isCorrect === true) {
                    modalContentEl.classList.add('correct-modal');
                } else if (isCorrect === false) {
                    modalContentEl.classList.add('incorrect-modal');
                }
                modalEl.classList.remove('hidden');
            }

            function closeModal() {
                modalEl.classList.add('hidden');
                if (currentLevel === 1) {
                   nextLevel1Question();
                }
                 if (currentLevel === 2) {
                    nextLevel2Challenge();
                }
            }

            // --- L√íGICA NIVELL 1 ---
            function loadLevel1Question() {
                if (l1_currentQuestionIndex >= level1Questions.length) {
                    l1_substanceNameEl.textContent = "Nivell 1 completat!";
                    l1_step1El.classList.add('hidden');
                    l1_step2El.classList.add('hidden');
                    l1_hintBtn.classList.add('hidden');
                    return;
                }
                const question = level1Questions[l1_currentQuestionIndex];
                l1_substanceNameEl.textContent = question.substance;
                resetLevel1State();
            }

            function resetLevel1State() {
                l1_step1El.classList.remove('hidden');
                l1_step2El.classList.add('hidden');
                l1_hintBtn.disabled = false;
                document.querySelectorAll('.l1-step1-btn, .l1-step2-btn').forEach(btn => btn.disabled = false);
            }

            function handleL1Step1(e) {
                const userAnswer1 = e.target.dataset.answer;
                const question = level1Questions[l1_currentQuestionIndex];

                if (userAnswer1 === question.type1) {
                    if (question.type1 === 'pura') {
                        l1_step1El.classList.add('hidden');
                        l1_step2El.classList.remove('hidden');
                    } else {
                        handleL1Result(true, userAnswer1, null);
                    }
                } else {
                    handleL1Result(false, userAnswer1, null);
                }
            }

            function handleL1Step2(e) {
                const userAnswer2 = e.target.dataset.answer;
                const question = level1Questions[l1_currentQuestionIndex];
                const firstAnswer = question.type1; // We know this is correct to reach step 2
                const isCorrect = userAnswer2 === question.type2;
                handleL1Result(isCorrect, firstAnswer, userAnswer2);
            }
            
            function handleL1Result(isCorrect, ans1, ans2) {
                 const question = level1Questions[l1_currentQuestionIndex];
                 document.querySelectorAll('.l1-step1-btn, .l1-step2-btn').forEach(btn => btn.disabled = true);
                 l1_hintBtn.disabled = true;
                 
                 showModal(isCorrect ? "Correcte!" : "Incorrecte.", question.explanation, isCorrect);

                 if (isCorrect) {
                     updateScore(10);
                 }
                 
                 const finalAnswer = ans2 ? `${ans1}, ${ans2}` : ans1;
                 reportData.push({
                     level: 1,
                     question: `Classificar: ${question.substance}`,
                     answer: finalAnswer,
                     isCorrect: isCorrect,
                     points: isCorrect ? 10 : 0
                 });
            }

            function nextLevel1Question() {
                l1_currentQuestionIndex++;
                loadLevel1Question();
            }
            
            function showLevel1Hint() {
                const question = level1Questions[l1_currentQuestionIndex];
                showModal("Pista", question.hint, null);
                updateScore(-2);
                l1_hintBtn.disabled = true;
                reportData.push({
                     level: 1,
                     question: `Pista per a: ${question.substance}`,
                     answer: `(ha demanat pista)`,
                     isCorrect: null,
                     points: -2
                 });
            }


            // --- L√íGICA NIVELL 2 ---
             function loadLevel2Challenge() {
                if (l2_currentChallengeIndex >= level2Challenges.length) {
                    l2_goalEl.textContent = "Nivell 2 completat!";
                    l2_paletteEl.innerHTML = "";
                    l2_recipientEl.innerHTML = "";
                    l2_verifyBtn.classList.add('hidden');
                    l2_resetBtn.classList.add('hidden');
                    l2_hintBtn.classList.add('hidden');
                    return;
                }
                const challenge = level2Challenges[l2_currentChallengeIndex];
                l2_goalEl.textContent = challenge.goal;
                l2_paletteEl.innerHTML = '';
                
                masterPalette.forEach(comp => {
                    const compContainer = document.createElement('div');
                    compContainer.className = 'atom-button flex flex-col items-center justify-center p-2 rounded-lg';
                    compContainer.title = comp.displayName;
                    
                    const visualEl = document.createElement('div');
                    visualEl.className = comp.type === 'atom' ? 'atom-container' : 'molecule-container';

                    comp.atoms.forEach(atom => {
                        const atomSphere = document.createElement('div');
                        atomSphere.className = `atom-sphere ${atom.color}`;
                        visualEl.appendChild(atomSphere);
                    });
                    
                    compContainer.appendChild(visualEl);
                    compContainer.addEventListener('click', () => addComponentToRecipient(comp));
                    l2_paletteEl.appendChild(compContainer);
                });

                resetLevel2Recipient();
                l2_verifyBtn.disabled = false;
                l2_verifyBtn.textContent = "Verifica";
                l2_resetBtn.disabled = false;
                l2_hintBtn.disabled = false;
            }

            function addComponentToRecipient(comp) {
                l2_recipientItems.push(comp);
                const visualClone = document.createElement('div');
                visualClone.className = 'recipient-item';
                const container = document.createElement('div');
                container.className = comp.type === 'atom' ? 'atom-container' : 'molecule-container';
                comp.atoms.forEach(atom => {
                    const atomSphere = document.createElement('div');
                    atomSphere.className = `atom-sphere ${atom.color}`;
                    container.appendChild(atomSphere);
                });
                visualClone.appendChild(container);
                l2_recipientEl.appendChild(visualClone);
            }

            function resetLevel2Recipient() {
                l2_recipientItems = [];
                l2_recipientEl.innerHTML = '';
            }
            
            function verifyLevel2() {
                l2_verifyBtn.disabled = true;
                l2_verifyBtn.innerHTML = `<svg class="animate-spin h-5 w-5 mr-3 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10" stroke-width="4" stroke-dasharray="20 10" stroke-linecap="round"></circle></svg> Verificant...`;
                
                setTimeout(() => {
                    const challenge = level2Challenges[l2_currentChallengeIndex];
                    const isCorrect = challenge.validation(l2_recipientItems);
                    
                    showModal(isCorrect ? "Correcte!" : "Incorrecte.", challenge.explanation, isCorrect);
                    
                    if (isCorrect) {
                        updateScore(15);
                    }

                    l2_hintBtn.disabled = true;
                    reportData.push({
                         level: 2,
                         question: `Construir: ${challenge.goal}`,
                         answer: l2_recipientItems.map(item => item.displayName).join(', ') || '(buit)',
                         isCorrect: isCorrect,
                         points: isCorrect ? 15 : 0
                     });
                     
                }, 500); // Small delay to show processing state
            }

            function nextLevel2Challenge() {
                l2_currentChallengeIndex++;
                loadLevel2Challenge();
            }

            function showLevel2Hint() {
                 const challenge = level2Challenges[l2_currentChallengeIndex];
                 showModal("Pista", challenge.hint, null);
                 updateScore(-2);
                 l2_hintBtn.disabled = true;
                 reportData.push({
                     level: 2,
                     question: `Pista per a: ${challenge.goal}`,
                     answer: `(ha demanat pista)`,
                     isCorrect: null,
                     points: -2
                 });
            }

            // --- GENERACI√ì D'INFORME ---
            function generateReport() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const studentName = document.getElementById('student-name').value || 'An√≤nim';
                const date = new Date().toLocaleDateString('ca-ES');
                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                let y = 0;

                let totalObtainedPoints = 0;
                let totalPossiblePoints = 0;
                reportData.forEach(item => {
                    if (item.isCorrect === true) {
                        totalObtainedPoints += item.points;
                        totalPossiblePoints += item.points;
                    } else if (item.isCorrect === false) {
                        if (item.level === 1) totalPossiblePoints += 10;
                        if (item.level === 2) totalPossiblePoints += 15;
                    }
                });
                const percentage = totalPossiblePoints > 0 ? Math.round((totalObtainedPoints / totalPossiblePoints) * 100) : 0;
                
                doc.setFillColor(79, 70, 229);
                doc.rect(0, 0, pageWidth, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.text("Informe de Resultats", pageWidth / 2, 16, { align: 'center' });
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text("Classificador de Mat√®ria", pageWidth / 2, 22, { align: 'center' });
                y = 40;

                doc.setTextColor(0, 0, 0);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Resum de l'Activitat", 14, y);
                y += 5;
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.5);
                doc.rect(14, y, pageWidth - 28, 25);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(12);
                doc.text(`Alumne/a: ${studentName}`, 20, y + 8);
                doc.text(`Data: ${date}`, 20, y + 15);
                doc.setFont(undefined, 'bold');
                doc.text(`Puntuaci√≥ Final: ${score} (${percentage}% d'encerts)`, pageWidth - 20, y + 15, { align: 'right' });
                y += 35;
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Detall de Respostes", 14, y);
                y += 8;
                doc.setFillColor(243, 244, 246);
                doc.rect(14, y, pageWidth - 28, 10, 'F');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text("Nivell", 18, y + 7);
                doc.text("Pregunta / Repte", 40, y + 7);
                doc.text("Resultat", 150, y + 7);
                doc.text("Punts", 185, y + 7);
                y += 10;

                reportData.forEach((item) => {
                    if (y > pageHeight - 30) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    const questionText = doc.splitTextToSize(item.question, 95);
                    const rowHeight = (questionText.length * 5) + 5;

                    doc.setDrawColor(229, 231, 235);
                    doc.line(14, y + rowHeight, pageWidth - 14, y + rowHeight);
                    
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(107, 114, 128);
                    doc.text(`${item.level}`, 20, y + 7);
                    
                    doc.setTextColor(0, 0, 0);
                    doc.text(questionText, 40, y + 7);
                    
                    doc.setFont(undefined, 'bold');
                    if (item.isCorrect === true) {
                        doc.setTextColor(22, 163, 74);
                        doc.text("Correcte", 150, y + 7);
                    } else if (item.isCorrect === false) {
                        doc.setTextColor(220, 38, 38);
                        doc.text("Incorrecte", 150, y + 7);
                    } else {
                        doc.setTextColor(96, 165, 250);
                        doc.text("Pista", 150, y + 7);
                    }
                    
                    doc.setTextColor(0, 0, 0);
                    doc.text(item.points.toString(), 188, y + 7);

                    y += rowHeight;
                });

                doc.setDrawColor(200, 200, 200);
                doc.line(14, pageHeight-15, pageWidth-14, pageHeight-15);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text("Informe generat per l'aplicaci√≥ Classificador de Mat√®ria.", pageWidth/2, pageHeight-10, {align: 'center'});

                doc.save(`informe_quimica_${studentName.replace(/\s/g, '_')}.pdf`);
            }

        });
    </script>
</body>
</html>

