<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joc de Partícules Subatòmiques</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Red theme background */
            background-color: #fee2e2;
            background-image: linear-gradient(to top right, #fee2e2, #fecaca);
        }
        .dark body {
             background-color: #7f1d1d;
             background-image: linear-gradient(to top right, #7f1d1d, #991b1b);
        }
        /* Card design */
        .card {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .dark .card {
            background-color: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Symbol display adjustments */
        .symbol-container { display: flex; align-items: center; justify-content: center; min-height: 150px; }
        .symbol-display { font-size: 6rem; line-height: 1; font-weight: 800; position: relative; display: inline-block; margin: 0 2.8rem; }
        .symbol-mass, .symbol-atomic, .symbol-charge { position: absolute; font-size: 2rem; font-weight: 500; line-height: 1; color: #dc2626; } /* red-600 */
        .dark .symbol-mass, .dark .symbol-atomic, .dark .symbol-charge { color: #fca5a5; } /* red-300 */
        
        /* Adjusted positioning */
        .symbol-mass { top: -0.2em; left: -1.1em; }
        .symbol-atomic { bottom: -0.2em; left: -1.1em; }
        .symbol-charge { top: -0.2em; right: -1.1em; }

        /* General UI styling */
        .transition-all { transition: all 0.3s ease-in-out; }
        
        /* --- FINAL COLOR THEME: RED --- */
        .btn-primary {
            background-color: #dc2626; /* red-600 */
            box-shadow: 0 4px 14px 0 rgba(220, 38, 38, 0.3);
        }
        .btn-primary:hover {
            background-color: #b91c1c; /* red-700 */
        }
        .btn-secondary {
            background-color: #64748b; /* slate-500 */
            box-shadow: 0 4px 14px 0 rgba(100, 116, 139, 0.2);
        }
        .btn-secondary:hover {
            background-color: #475569; /* slate-600 */
        }
        .btn-success {
            background-color: #16a34a; /* green-600 */
            box-shadow: 0 4px 14px 0 rgba(22, 163, 74, 0.3);
        }
        .btn-success:hover {
            background-color: #15803d; /* green-700 */
        }
        
        /* Results styling */
        .results-grid { display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; }
        .results-grid > dt { font-weight: 600; color: #dc2626; }
        .dark .results-grid > dt { color: #fca5a5; }
        .user-answer-correct { color: #16a34a; font-weight: 600; }
        .user-answer-incorrect { color: #ef4444; font-weight: 600; text-decoration: line-through; }
        .correct-answer-text { color: #16a34a; font-weight: 600; }
    </style>
</head>
<body class="transition-all">

    <div class="w-full max-w-2xl mx-auto rounded-3xl shadow-xl p-6 md:p-8 transition-all card my-8">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-red-600 dark:text-red-400 mb-2">Joc de Partícules Subatòmiques</h1>
        
        <div id="instructions" class="text-sm text-center text-gray-600 dark:text-gray-400 bg-red-100 dark:bg-red-900/30 p-3 rounded-lg mb-6">
            <p class="font-semibold">Instruccions:</p>
            <ul class="list-disc list-inside">
                <li>Completa els camps buits amb els números corresponents.</li>
                <li>Per a la càrrega, posa el signe davant del número (ex: <strong>-2</strong>, <strong>+1</strong>). Posa <strong>0</strong> si és neutre.</li>
            </ul>
        </div>

        <div id="game-container">
            <!-- Game content will be injected here -->
        </div>
        
        <div id="round-results-screen" class="hidden text-center py-8">
            <h2 id="round-results-title" class="text-3xl font-bold mb-2">Resultats de la Ronda 1</h2>
            <p id="round-score" class="text-2xl mb-6"></p>
            <div class="flex flex-col md:flex-row justify-center items-center gap-4 mt-6">
                <button id="repeat-round-btn" class="w-full md:w-auto btn-secondary text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105">Repetir Ronda</button>
                <button id="continue-game-btn" class="w-full md:w-auto btn-primary text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105">Continuar</button>
                <button id="round-pdf-btn" class="w-full md:w-auto btn-success text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105">Generar Informe</button>
            </div>
             <div class="mt-8 text-left">
                <div id="round-summary" class="space-y-6"></div>
            </div>
        </div>

        <div id="end-game-screen" class="hidden text-center py-8">
            <h2 class="text-3xl font-bold mb-2">Partida Acabada!</h2>
            <p id="final-score" class="text-2xl mb-6"></p>
            
            <div class="my-8">
                <div class="flex flex-col md:flex-row justify-center items-center gap-4 mt-6">
                    <button id="restart-btn" class="w-full md:w-auto btn-secondary text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105">Jugar de Nou</button>
                    <button id="pdf-btn" class="w-full md:w-auto btn-primary text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105">Generar Informe Final</button>
                </div>
            </div>

            <div class="mt-8 text-left">
                <h3 class="text-2xl font-bold mb-4 text-center">Resum de Respostes Finals</h3>
                <div id="results-summary" class="space-y-6"></div>
            </div>
        </div>
    </div>
    
    <!-- PDF Name Modal -->
    <div id="pdf-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6 md:p-8 max-w-sm w-full card">
            <h3 class="text-xl font-bold mb-4 text-center text-red-600 dark:text-red-400">Generar Informe PDF</h3>
            <div class="space-y-2">
                <label for="pdf-student-name" class="block text-left text-lg font-semibold dark:text-gray-300">Introdueix el teu nom:</label>
                <input type="text" id="pdf-student-name" class="w-full bg-slate-100 dark:bg-slate-700 border-2 border-slate-300 dark:border-slate-600 rounded-lg p-3 text-center text-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all" placeholder="El teu nom i cognoms">
            </div>
            <div class="grid grid-cols-2 gap-4 mt-6">
                <button id="cancel-pdf-btn" class="w-full btn-secondary text-white font-bold py-3 px-4 rounded-lg transition-all transform hover:scale-105">Cancel·lar</button>
                <button id="confirm-pdf-btn" class="w-full btn-primary text-white font-bold py-3 px-4 rounded-lg transition-all transform hover:scale-105">Descarregar</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const allElements = [
            { symbol: 'H', name: 'Hidrogen', atomicNumber: 1, massNumber: 1, charge: 0 }, { symbol: 'H', name: 'Hidrogen', atomicNumber: 1, massNumber: 1, charge: 1 }, { symbol: 'D', name: 'Deuteri', atomicNumber: 1, massNumber: 2, charge: 0 }, { symbol: 'He', name: 'Heli', atomicNumber: 2, massNumber: 4, charge: 0 }, { symbol: 'Li', name: 'Liti', atomicNumber: 3, massNumber: 7, charge: 1 }, { symbol: 'Be', name: 'Beril·li', atomicNumber: 4, massNumber: 9, charge: 2 }, { symbol: 'B', name: 'Bor', atomicNumber: 5, massNumber: 11, charge: 0 }, { symbol: 'C', name: 'Carboni', atomicNumber: 6, massNumber: 12, charge: 0 }, { symbol: 'C', name: 'Carboni', atomicNumber: 6, massNumber: 14, charge: 0 }, { symbol: 'N', name: 'Nitrogen', atomicNumber: 7, massNumber: 14, charge: 0 }, { symbol: 'N', name: 'Nitrogen', atomicNumber: 7, massNumber: 14, charge: -3 }, { symbol: 'O', name: 'Oxigen', atomicNumber: 8, massNumber: 16, charge: 0 }, { symbol: 'O', name: 'Oxigen', atomicNumber: 8, massNumber: 16, charge: -2 }, { symbol: 'F', name: 'Fluor', atomicNumber: 9, massNumber: 19, charge: -1 }, { symbol: 'Ne', name: 'Neó', atomicNumber: 10, massNumber: 20, charge: 0 }, { symbol: 'Na', name: 'Sodi', atomicNumber: 11, massNumber: 23, charge: 1 }, { symbol: 'Mg', name: 'Magnesi', atomicNumber: 12, massNumber: 24, charge: 2 }, { symbol: 'Al', name: 'Alumini', atomicNumber: 13, massNumber: 27, charge: 3 }, { symbol: 'Si', name: 'Silici', atomicNumber: 14, massNumber: 28, charge: 0 }, { symbol: 'P', name: 'Fòsfor', atomicNumber: 15, massNumber: 31, charge: -3 }, { symbol: 'S', name: 'Sofre', atomicNumber: 16, massNumber: 32, charge: -2 }, { symbol: 'Cl', name: 'Clor', atomicNumber: 17, massNumber: 35, charge: -1 }, { symbol: 'Ar', name: 'Argó', atomicNumber: 18, massNumber: 40, charge: 0 }, { symbol: 'K', name: 'Potassi', atomicNumber: 19, massNumber: 39, charge: 1 }, { symbol: 'Ca', name: 'Calci', atomicNumber: 20, massNumber: 40, charge: 2 }, { symbol: 'Fe', name: 'Ferro', atomicNumber: 26, massNumber: 56, charge: 2 }, { symbol: 'Fe', name: 'Ferro', atomicNumber: 26, massNumber: 56, charge: 3 }, { symbol: 'Cu', name: 'Coure', atomicNumber: 29, massNumber: 64, charge: 1 }, { symbol: 'Cu', name: 'Coure', atomicNumber: 29, massNumber: 64, charge: 2 }, { symbol: 'Br', name: 'Brom', atomicNumber: 35, massNumber: 80, charge: -1 }, { symbol: 'Ag', name: 'Plata', atomicNumber: 47, massNumber: 108, charge: 1 }, { symbol: 'I', name: 'Iode', atomicNumber: 53, massNumber: 127, charge: -1 }, { symbol: 'Pb', name: 'Plom', atomicNumber: 82, massNumber: 207, charge: 2 }, { symbol: 'U', name: 'Urani', atomicNumber: 92, massNumber: 238, charge: 0 }, { symbol: 'U', name: 'Urani', atomicNumber: 92, massNumber: 235, charge: 0 },
        ];
        
        // --- GAME STATE ---
        let currentElement = null, score = 0, gameElements = [], questionCount = 0, currentQuestionType = '';
        let resultsHistory = [];
        const totalQuestions = 20;
        const questionsPerRound = 10;
        let currentRound = 1;

        // --- DOM ELEMENTS ---
        const gameContainer = document.getElementById('game-container');
        const roundResultsScreen = document.getElementById('round-results-screen');
        const endGameScreen = document.getElementById('end-game-screen');
        const finalScoreEl = document.getElementById('final-score');
        const restartBtn = document.getElementById('restart-btn');
        const pdfBtn = document.getElementById('pdf-btn');
        const resultsSummaryEl = document.getElementById('results-summary');
        const pdfModal = document.getElementById('pdf-modal');
        const pdfStudentNameInput = document.getElementById('pdf-student-name');
        const confirmPdfBtn = document.getElementById('confirm-pdf-btn');
        const cancelPdfBtn = document.getElementById('cancel-pdf-btn');

        // --- TEMPLATES ---
        const gameHTML = `
            <p id="question-counter" class="text-center text-gray-500 dark:text-gray-400 mb-4 font-semibold"></p>
            <div id="guess-particles-container" class="hidden">
                <p class="text-center text-lg mb-6 dark:text-gray-300">Quantes partícules té aquest element/ió?</p>
                <div class="symbol-container mb-8">
                    <div class="symbol-display text-gray-800 dark:text-gray-200">
                        <span id="mass-number" class="symbol-mass"></span><span id="atomic-number" class="symbol-atomic"></span>
                        <span id="element-main" class="symbol-main"></span><span id="charge" class="symbol-charge"></span>
                    </div>
                </div>
                <div class="space-y-4 mb-6">
                    <div class="grid grid-cols-3 gap-4 items-center">
                        <label for="protons" class="col-span-1 font-semibold text-lg">Protons (p⁺):</label>
                        <input type="number" id="protons" class="col-span-2 bg-slate-100 dark:bg-slate-700 border-2 border-slate-300 dark:border-slate-600 rounded-lg p-3 text-center text-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all" placeholder="?">
                    </div>
                    <div class="grid grid-cols-3 gap-4 items-center">
                        <label for="neutrons" class="col-span-1 font-semibold text-lg">Neutrons (n⁰):</label>
                        <input type="number" id="neutrons" class="col-span-2 bg-slate-100 dark:bg-slate-700 border-2 border-slate-300 dark:border-slate-600 rounded-lg p-3 text-center text-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all" placeholder="?">
                    </div>
                    <div class="grid grid-cols-3 gap-4 items-center">
                        <label for="electrons" class="col-span-1 font-semibold text-lg">Electrons (e⁻):</label>
                        <input type="number" id="electrons" class="col-span-2 bg-slate-100 dark:bg-slate-700 border-2 border-slate-300 dark:border-slate-600 rounded-lg p-3 text-center text-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all" placeholder="?">
                    </div>
                </div>
            </div>
            <div id="guess-numbers-container" class="hidden">
                 <p class="text-center text-lg mb-6 dark:text-gray-300">A quin element/ió corresponen aquestes partícules?</p>
                <div class="bg-red-100 dark:bg-red-900/30 rounded-lg p-4 mb-8 text-center space-y-2">
                    <p class="text-lg">Protons (p⁺): <strong id="given-protons" class="text-red-600 dark:text-red-400"></strong></p>
                    <p class="text-lg">Neutrons (n⁰): <strong id="given-neutrons" class="text-red-600 dark:text-red-400"></strong></p>
                    <p class="text-lg">Electrons (e⁻): <strong id="given-electrons" class="text-red-600 dark:text-red-400"></strong></p>
                </div>
                 <div class="space-y-4 mb-6">
                    <div class="grid grid-cols-3 gap-4 items-center">
                        <label for="atomic-input" class="col-span-1 font-semibold text-lg">N. Atòmic (Z):</label>
                        <input type="number" id="atomic-input" class="col-span-2 bg-slate-100 dark:bg-slate-700 border-2 border-slate-300 dark:border-slate-600 rounded-lg p-3 text-center text-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all" placeholder="?">
                    </div>
                    <div class="grid grid-cols-3 gap-4 items-center">
                        <label for="mass-input" class="col-span-1 font-semibold text-lg">N. Màssic (A):</label>
                        <input type="number" id="mass-input" class="col-span-2 bg-slate-100 dark:bg-slate-700 border-2 border-slate-300 dark:border-slate-600 rounded-lg p-3 text-center text-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all" placeholder="?">
                    </div>
                    <div class="grid grid-cols-3 gap-4 items-center">
                        <label for="charge-input" class="col-span-1 font-semibold text-lg">Càrrega:</label>
                        <input type="number" id="charge-input" class="col-span-2 bg-slate-100 dark:bg-slate-700 border-2 border-slate-300 dark:border-slate-600 rounded-lg p-3 text-center text-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all" placeholder="?">
                    </div>
                </div>
            </div>
            <div class="mt-8">
                <button id="next-btn" class="w-full btn-primary text-white font-bold py-3 px-4 rounded-lg transition-all transform hover:scale-105">Següent</button>
            </div>
             <div class="text-center mt-6">
                <p class="text-lg font-medium text-gray-700 dark:text-gray-300">Puntuació Total: <span id="score" class="font-bold text-red-600 dark:text-red-400">0</span></p>
            </div>`;

        // --- FUNCTIONS ---
        function startGame() {
            score = 0;
            questionCount = 0;
            currentRound = 1;
            resultsHistory = [];
            const shuffled = [...allElements].sort(() => 0.5 - Math.random());
            gameElements = shuffled.slice(0, totalQuestions);
            
            endGameScreen.classList.add('hidden');
            roundResultsScreen.classList.add('hidden');
            gameContainer.innerHTML = gameHTML;
            gameContainer.classList.remove('hidden');
            document.getElementById('instructions').classList.remove('hidden');
            
            setupEventListeners();
            setupNewQuestion();
        }

        function setupEventListeners() {
            document.getElementById('next-btn').addEventListener('click', recordAnswerAndNext);
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('keyup', (event) => {
                    if (event.key === 'Enter') {
                        document.getElementById('next-btn').click();
                    }
                });
            });
        }

        function setupNewQuestion() {
             if(questionCount >= totalQuestions) {
                endGame();
                return;
            }

            currentElement = gameElements[questionCount];
            currentQuestionType = Math.random() < 0.5 ? 'guessParticles' : 'guessNumbers';
            
            resetUI();
            
            if (currentQuestionType === 'guessParticles') {
                setupGuessParticles();
            } else {
                setupGuessNumbers();
            }
        }
        
        function recordAnswerAndNext() {
            let userAnswers;
            if (currentQuestionType === 'guessParticles') {
                const userProtons = document.getElementById('protons').value;
                const userNeutrons = document.getElementById('neutrons').value;
                const userElectrons = document.getElementById('electrons').value;
                userAnswers = { 
                    p: userProtons === '' ? '?' : parseInt(userProtons, 10), 
                    n: userNeutrons === '' ? '?' : parseInt(userNeutrons, 10), 
                    e: userElectrons === '' ? '?' : parseInt(userElectrons, 10) 
                };
            } else {
                 const userAtomic = document.getElementById('atomic-input').value;
                 const userMass = document.getElementById('mass-input').value;
                 const userCharge = document.getElementById('charge-input').value;
                 userAnswers = {
                    Z: userAtomic === '' ? '?' : parseInt(userAtomic, 10),
                    A: userMass === '' ? '?' : parseInt(userMass, 10),
                    C: userCharge === '' ? '?' : parseInt(userCharge, 10)
                 };
            }
            resultsHistory.push({
                element: currentElement,
                questionType: currentQuestionType,
                userAnswers: userAnswers,
            });

            questionCount++;
            
            if (questionCount % questionsPerRound === 0 && questionCount > 0) {
                evaluateRoundAndShowResults();
            } else {
                setupNewQuestion();
            }
        }

        function evaluateRoundAndShowResults() {
            gameContainer.classList.add('hidden');
            roundResultsScreen.classList.remove('hidden');
            
            const roundStartIdx = (currentRound - 1) * questionsPerRound;
            const roundEndIdx = roundStartIdx + questionsPerRound;
            let roundScore = 0;

            for(let i = roundStartIdx; i < roundEndIdx; i++) {
                const result = resultsHistory[i];
                if (!result) continue; // Safeguard
                let allCorrect = false;
                if (result.questionType === 'guessParticles') {
                    const correctProtons = result.element.atomicNumber;
                    const correctNeutrons = result.element.massNumber - result.element.atomicNumber;
                    const correctElectrons = result.element.atomicNumber - result.element.charge;
                    result.correctAnswers = { p: correctProtons, n: correctNeutrons, e: correctElectrons };
                    allCorrect = (result.userAnswers.p === correctProtons && result.userAnswers.n === correctNeutrons && result.userAnswers.e === correctElectrons);
                } else {
                    const correctAtomic = result.element.atomicNumber;
                    const correctMass = result.element.massNumber;
                    const correctCharge = result.element.charge;
                    result.correctAnswers = { Z: correctAtomic, A: correctMass, C: correctCharge };
                    allCorrect = (result.userAnswers.Z === correctAtomic && result.userAnswers.A === correctMass && result.userAnswers.C === correctCharge);
                }
                result.isCorrect = allCorrect;
                if(allCorrect) roundScore++;
            }

            score += roundScore;
            
            document.getElementById('round-results-title').textContent = `Resultats de la Ronda ${currentRound}`;
            document.getElementById('round-score').innerHTML = `Puntuació de la Ronda: <strong class="text-red-600 dark:text-red-400">${roundScore}</strong> de <strong class="text-red-600 dark:text-red-400">${questionsPerRound}</strong>.`;
            displayRoundResults(roundStartIdx, roundEndIdx);

            const continueBtn = document.getElementById('continue-game-btn');
            if (currentRound >= (totalQuestions / questionsPerRound)) {
                continueBtn.textContent = 'Finalitzar i Veure Resum';
                continueBtn.onclick = endGame;
            } else {
                continueBtn.textContent = 'Següent Ronda';
                continueBtn.onclick = continueToNextRound;
            }
            document.getElementById('repeat-round-btn').onclick = repeatRound;
            document.getElementById('round-pdf-btn').onclick = showPdfModal;
        }

        function displayRoundResults(startIdx, endIdx) {
            const summaryEl = document.getElementById('round-summary');
            summaryEl.innerHTML = '';
            const roundResults = resultsHistory.slice(startIdx, endIdx);
            roundResults.forEach((result, index) => {
                summaryEl.innerHTML += getResultCardHTML(result, startIdx + index);
            });
        }
        
        function repeatRound() {
            const roundStartIdx = (currentRound - 1) * questionsPerRound;
            let roundScoreToRemove = 0;
            const roundEndIdx = roundStartIdx + questionsPerRound;
            const currentRoundResults = resultsHistory.slice(roundStartIdx, roundEndIdx);
            
            for(const result of currentRoundResults) {
                if(result.isCorrect) roundScoreToRemove++;
            }
            score -= roundScoreToRemove;

            resultsHistory.splice(roundStartIdx);
            questionCount = roundStartIdx;
            
            roundResultsScreen.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            document.getElementById('score').textContent = score;
            setupNewQuestion();
        }

        function continueToNextRound() {
            currentRound++;
            roundResultsScreen.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            setupNewQuestion();
        }

        function resetUI() {
            document.getElementById('question-counter').textContent = `Ronda ${currentRound} - Pregunta ${questionCount % questionsPerRound + 1} de ${questionsPerRound}`;
            document.getElementById('score').textContent = score;
            
            document.querySelectorAll('input[type="number"]').forEach(input => input.value = '');
        }

        function setupGuessParticles() {
            document.getElementById('guess-numbers-container').classList.add('hidden');
            document.getElementById('guess-particles-container').classList.remove('hidden');
            document.getElementById('mass-number').textContent = currentElement.massNumber;
            document.getElementById('atomic-number').textContent = currentElement.atomicNumber;
            document.getElementById('element-main').textContent = currentElement.symbol;
            if (currentElement.charge === 0) {
                document.getElementById('charge').textContent = '';
            } else {
                const sign = currentElement.charge > 0 ? '+' : '−';
                const absCharge = Math.abs(currentElement.charge);
                document.getElementById('charge').textContent = (absCharge === 1) ? sign : `${absCharge}${sign}`;
            }
            document.getElementById('protons').focus();
        }

        function setupGuessNumbers() {
            document.getElementById('guess-particles-container').classList.add('hidden');
            document.getElementById('guess-numbers-container').classList.remove('hidden');
            const protons = currentElement.atomicNumber;
            const neutrons = currentElement.massNumber - currentElement.atomicNumber;
            const electrons = currentElement.atomicNumber - currentElement.charge;
            document.getElementById('given-protons').textContent = protons;
            document.getElementById('given-neutrons').textContent = neutrons;
            document.getElementById('given-electrons').textContent = electrons;
            document.getElementById('atomic-input').focus();
        }

        function endGame() {
            gameContainer.classList.add('hidden');
            roundResultsScreen.classList.add('hidden');
            document.getElementById('instructions').classList.add('hidden');
            endGameScreen.classList.remove('hidden');
            const questionsPlayed = resultsHistory.length;
            finalScoreEl.innerHTML = `Puntuació Final: <strong class="text-red-600 dark:text-red-400">${score}</strong> de <strong class="text-red-600 dark:text-red-400">${questionsPlayed}</strong>.`;
            displayFinalResults();
        }

        function displayFinalResults() {
            resultsSummaryEl.innerHTML = '';
            resultsHistory.forEach((result, index) => {
                 resultsSummaryEl.innerHTML += getResultCardHTML(result, index);
            });
        }
        
        function getResultCardHTML(result, index) {
            const { element, questionType, userAnswers, correctAnswers, isCorrect } = result;
            let questionHTML = '', answersHTML = '';

            if (questionType === 'guessParticles') {
                const chargeText = element.charge === 0 ? '' : (Math.abs(element.charge) === 1 ? (element.charge > 0 ? '+' : '−') : `${Math.abs(element.charge)}${element.charge > 0 ? '+' : '−'}`);
                questionHTML = `Pregunta: <strong><sup>${element.massNumber}</sup><sub>${element.atomicNumber}</sub>${element.symbol}<sup>${chargeText}</sup></strong>`;
                answersHTML = `<dl class="results-grid mt-2">
                        <dt>Protons (p⁺):</dt><dd>${formatAnswer(userAnswers.p, correctAnswers.p)}</dd>
                        <dt>Neutrons (n⁰):</dt><dd>${formatAnswer(userAnswers.n, correctAnswers.n)}</dd>
                        <dt>Electrons (e⁻):</dt><dd>${formatAnswer(userAnswers.e, correctAnswers.e)}</dd></dl>`;
            } else {
                questionHTML = `Pregunta: <strong>p⁺=${correctAnswers.Z}, n⁰=${correctAnswers.A - correctAnswers.Z}, e⁻=${correctAnswers.Z - correctAnswers.C}</strong>`;
                    answersHTML = `<dl class="results-grid mt-2">
                        <dt>N. Atòmic (Z):</dt><dd>${formatAnswer(userAnswers.Z, correctAnswers.Z)}</dd>
                        <dt>N. Màssic (A):</dt><dd>${formatAnswer(userAnswers.A, correctAnswers.A)}</dd>
                        <dt>Càrrega:</dt><dd>${formatAnswer(userAnswers.C, correctAnswers.C)}</dd></dl>`;
            }

            return `<div class="p-4 rounded-lg ${isCorrect ? 'bg-green-50 dark:bg-green-900/20' : 'bg-red-50 dark:bg-red-900/20'}">
                    <p class="font-semibold text-lg">${index + 1}. ${questionHTML}</p>${answersHTML}</div>`;
        }

        function formatAnswer(user, correct) {
            if (user === correct) {
                return `<span class="user-answer-correct">${user} ✔</span>`;
            }
            return `<span class="user-answer-incorrect">${user}</span> <span class="correct-answer-text">→ ${correct}</span>`;
        }
        
        function generatePDF(studentName) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const name = studentName || 'Anònim';
            const questionsPlayed = resultsHistory.length;

            doc.setFontSize(20);
            doc.text("Informe de Resultats: Joc de Partícules", 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`Alumne/a: ${name}`, 14, 35);
            doc.text(`Puntuació: ${score} de ${questionsPlayed}`, 14, 42);

            const tableColumn = ["#", "Pregunta", "La Teva Resposta", "Resultat"];
            const tableRows = [];

            resultsHistory.forEach((result, index) => {
                const { element, questionType, userAnswers, correctAnswers, isCorrect } = result;
                let questionText, userAnswerText, resultText;

                if (questionType === 'guessParticles') {
                    const chargeText = element.charge === 0 ? '' : (Math.abs(element.charge) === 1 ? (element.charge > 0 ? '+' : '-') : `${Math.abs(element.charge)}${element.charge > 0 ? '+' : '-'}`);
                    questionText = `${element.massNumber}, ${element.atomicNumber}, ${element.symbol}, ${chargeText}`;
                    userAnswerText = `p: ${userAnswers.p}, n: ${userAnswers.n}, e: ${userAnswers.e}`;
                    resultText = isCorrect ? 'Correcte' : `Incorrecte. Correcta: p: ${correctAnswers.p}, n: ${correctAnswers.n}, e: ${correctAnswers.e}`;
                } else {
                    questionText = `p: ${correctAnswers.Z}, n: ${correctAnswers.A - correctAnswers.Z}, e: ${correctAnswers.Z - correctAnswers.C}`;
                    userAnswerText = `Z: ${userAnswers.Z}, A: ${userAnswers.A}, C: ${userAnswers.C}`;
                    resultText = isCorrect ? 'Correcte' : `Incorrecte. Correcta: Z: ${correctAnswers.Z}, A: ${correctAnswers.A}, C: ${correctAnswers.C}`;
                }
                tableRows.push([index + 1, questionText, userAnswerText, resultText]);
            });

            doc.autoTable({
                head: [tableColumn], body: tableRows, startY: 50, theme: 'grid',
                headStyles: { fillColor: [220, 38, 38] }, // Red color for PDF
                didParseCell: function (data) {
                    if (data.row.index >= 0 && resultsHistory[data.row.index] && !resultsHistory[data.row.index].isCorrect && data.column.index === 3) {
                         data.cell.styles.textColor = '#ef4444';
                    }
                }
            });
            doc.save(`resultats-${name.replace(/ /g, '_')}.pdf`);
        }
        
        // --- MODAL & INITIALIZE ---
        function showPdfModal() {
            pdfStudentNameInput.value = ''; // Clear previous input
            pdfModal.classList.remove('hidden');
            pdfStudentNameInput.focus();
        }

        function hidePdfModal() {
            pdfModal.classList.add('hidden');
        }

        restartBtn.addEventListener('click', startGame);
        pdfBtn.addEventListener('click', showPdfModal);
        cancelPdfBtn.addEventListener('click', hidePdfModal);
        confirmPdfBtn.addEventListener('click', () => {
            generatePDF(pdfStudentNameInput.value);
            hidePdfModal();
        });

        window.onload = startGame;

    </script>
</body>
</html>

