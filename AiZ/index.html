<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activitat Interactiva: Propietats Atòmiques d'Àtoms Neutres i Ions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .correct-cell-report {
            color: #065f46; /* Green-800 */
        }
        .incorrect-cell-report {
            color: #991b1b; /* Red-800 */
        }
        .input-cell {
            min-width: 60px;
            max-width: 100px;
            margin-left: auto;
            margin-right: auto;
        }
        button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
         @media print {
            body * {
                visibility: hidden;
            }
            #report-view, #report-view * {
                visibility: visible;
            }
            #report-view {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
            
            /* Additional print styles for better PDF generation */
            #printable-area {
                margin: 0;
                padding: 20px;
                font-size: 14px;
            }
            
            /* Ensure content sections don't break inappropriately */
            h3, .p-3, .bg-gray-100, .space-y-4 > div {
                page-break-inside: avoid;
            }
            
            /* Prevent table rows from breaking within the row */
            tr {
                page-break-inside: avoid;
            }
            
            /* Page break controls */
            .page-break-before {
                page-break-before: always;
            }
            
            .break-inside-avoid {
                page-break-inside: avoid;
            }
        }
        
        @media print {
            #printable-area {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                color-adjust: exact;
            }
        }
    </style>
</head>
<body class="bg-green-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8 hidden">
            <h1 class="text-3xl sm:text-4xl font-bold text-green-800">Propietats atòmiques d'àtoms neutres o ions</h1>
            <p class="mt-2 text-lg text-gray-600">Completa les 2 rondes per poder generar l'informe de la sessió.</p>
        </header>

        <main>
            <div id="level-selection-view">
                <div class="text-center p-8 bg-white rounded-lg shadow-lg">
                    <h2 class="text-2xl sm:text-3xl font-bold text-green-800 mb-6">Tria el teu nivell de dificultat</h2>
                    <div class="flex flex-col sm:flex-row justify-center items-center gap-6">
                        <button id="level-initial" class="w-full sm:w-auto px-8 py-4 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">
                            Nivell Inicial<br><span class="font-normal text-sm">(Àtoms Neutres)</span>
                        </button>
                        <button id="level-advanced" class="w-full sm:w-auto px-8 py-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">
                            Nivell Avançat<br><span class="font-normal text-sm">(Àtoms i Ions)</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="quiz-view" class="hidden">
                <p id="status-message" class="text-center text-xl font-semibold text-gray-700 mb-4"></p>
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full divide-y divide-gray-200 text-center">
                        <thead class="bg-green-600">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-xs sm:text-sm font-semibold text-white uppercase tracking-wider">Símbol</th>
                                <th scope="col" class="px-4 py-3 text-xs sm:text-sm font-semibold text-white uppercase tracking-wider">Nombre Atòmic (Z)</th>
                                <th scope="col" class="px-4 py-3 text-xs sm:text-sm font-semibold text-white uppercase tracking-wider">Nombre Màssic (A)</th>
                                <th scope="col" class="px-4 py-3 text-xs sm:text-sm font-semibold text-white uppercase tracking-wider">Protons (p⁺)</th>
                                <th scope="col" class="px-4 py-3 text-xs sm:text-sm font-semibold text-white uppercase tracking-wider">Neutrons (n⁰)</th>
                                <th scope="col" class="px-4 py-3 text-xs sm:text-sm font-semibold text-white uppercase tracking-wider">Electrons (e⁻)</th>
                                <th scope="col" class="px-4 py-3 text-xs sm:text-sm font-semibold text-white uppercase tracking-wider">Càrrega (q)</th>
                            </tr>
                        </thead>
                        <tbody id="quiz-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Les files seran generades per JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="mt-6 flex flex-col sm:flex-row flex-wrap justify-center items-center gap-4">
                     <button id="home-button" class="w-full sm:w-auto px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">
                        Inici
                    </button>
                    <button id="report-button" class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">
                        Generar Informe
                    </button>
                    <button id="next-action-button" class="w-full sm:w-auto px-6 py-3 bg-rose-600 text-white font-semibold rounded-lg shadow-md hover:bg-rose-700 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">
                        Següent Ronda
                    </button>
                </div>
            </div>
            <div id="report-view" class="hidden">
                <!-- El contingut de l'informe es generarà aquí -->
            </div>
        </main>
    </div>

    <!-- Finestra emergent (Modal) per a les dades de l'usuari -->
    <div id="user-info-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md transform transition-all duration-300 ease-out">
            <div class="flex justify-between items-center p-4 border-b border-green-200">
                <h2 class="text-2xl font-bold text-green-800">Dades per a l'Informe</h2>
                <button id="close-user-info-button" class="text-gray-500 hover:text-gray-800 text-3xl font-bold leading-none">&times;</button>
            </div>
            <div class="p-6">
                <form id="user-info-form">
                    <div class="mb-4">
                        <label for="user-name" class="block text-sm font-medium text-gray-700 mb-1">Nom</label>
                        <input type="text" id="user-name" name="user-name" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="user-surname" class="block text-sm font-medium text-gray-700 mb-1">Cognom</label>
                        <input type="text" id="user-surname" name="user-surname" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="user-class" class="block text-sm font-medium text-gray-700 mb-1">Classe</label>
                        <input type="text" id="user-class" name="user-class" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">
                            Generar Informe
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const atomPool = [
            { symbol: 'H', Z: 1, A: 1 }, { symbol: 'He', Z: 2, A: 4 }, { symbol: 'Li', Z: 3, A: 7 }, { symbol: 'Be', Z: 4, A: 9 }, { symbol: 'B', Z: 5, A: 11 }, { symbol: 'C', Z: 6, A: 12 }, { symbol: 'N', Z: 7, A: 14 }, { symbol: 'O', Z: 8, A: 16 }, { symbol: 'F', Z: 9, A: 19 }, { symbol: 'Ne', Z: 10, A: 20 }, { symbol: 'Na', Z: 11, A: 23 }, { symbol: 'Mg', Z: 12, A: 24 }, { symbol: 'Al', Z: 13, A: 27 }, { symbol: 'Si', Z: 14, A: 28 }, { symbol: 'P', Z: 15, A: 31 }, { symbol: 'S', Z: 16, A: 32 }, { symbol: 'Cl', Z: 17, A: 35 }, { symbol: 'Ar', Z: 18, A: 40 }, { symbol: 'K', Z: 19, A: 39 }, { symbol: 'Ca', Z: 20, A: 40 },
            { symbol: 'Sc', Z: 21, A: 45 }, { symbol: 'Ti', Z: 22, A: 48 }, { symbol: 'V', Z: 23, A: 51 }, { symbol: 'Cr', Z: 24, A: 52 }, { symbol: 'Mn', Z: 25, A: 55 }, { symbol: 'Fe', Z: 26, A: 56 }, { symbol: 'Co', Z: 27, A: 59 }, { symbol: 'Ni', Z: 28, A: 58 }, { symbol: 'Cu', Z: 29, A: 63 }, { symbol: 'Zn', Z: 30, A: 65 }
        ];

        const tableBody = document.getElementById('quiz-table-body');
        const nextActionButton = document.getElementById('next-action-button');
        const reportButton = document.getElementById('report-button');
        const homeButton = document.getElementById('home-button');
        const statusMessage = document.getElementById('status-message');
        const userInfoModal = document.getElementById('user-info-modal');
        const userInfoForm = document.getElementById('user-info-form');
        const closeUserInfoButton = document.getElementById('close-user-info-button');
        
        const propertyKeys = ['symbol', 'Z', 'A', 'p', 'n', 'e', 'q'];
        const NUM_QUESTIONS = 5;
        const NUM_ROUNDS = 2;
        let currentLevel = null;
        let currentQuizAtoms = [];
        let sessionHistory = [];
        let usedAtomsSymbols = new Set();
        let currentUserInfo = {};

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function generateTable(atoms) {
            tableBody.innerHTML = '';
            atoms.forEach(element => {
                const row = document.createElement('tr');
                row.id = `row-${element.id}`;
                propertyKeys.forEach(key => {
                    const cell = document.createElement('td');
                    cell.classList.add('px-4', 'py-3', 'text-sm', 'whitespace-nowrap');
                    if (element.show.includes(key)) {
                        const fixedValueContainer = document.createElement('div');
                        let displayValue = element[key];
                        if (key === 'q' && element[key] > 0) {
                            displayValue = `+${element[key]}`;
                        }
                        fixedValueContainer.textContent = displayValue;
                        fixedValueContainer.classList.add(
                            'w-full', 'p-2', 'text-center', 'border', 
                            'border-yellow-300', 'rounded-md', 'bg-yellow-100', 
                            'font-medium', 'text-gray-800', 'input-cell'
                        );
                        cell.appendChild(fixedValueContainer);
                    } else {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.id = `input-${element.id}-${key}`;
                        input.classList.add('w-full', 'p-2', 'text-center', 'border', 'border-gray-300', 'rounded-md', 'focus:ring-blue-500', 'focus:border-blue-500', 'input-cell');
                        cell.appendChild(input);
                    }
                    row.appendChild(cell);
                });
                tableBody.appendChild(row);
            });
        }

        function showLevelSelection() {
            document.getElementById('level-selection-view').classList.remove('hidden');
            document.getElementById('quiz-view').classList.add('hidden');
            document.querySelector('header').classList.add('hidden');
            const reportView = document.getElementById('report-view');
            reportView.classList.add('hidden');
            reportView.innerHTML = '';
            currentLevel = null;
        }
        
        function startNewSession() {
            sessionHistory = [];
            usedAtomsSymbols = new Set();
            currentUserInfo = {};
            startNewRound();
        }

        function startNewRound() {
            const availableAtoms = atomPool.filter(atom => !usedAtomsSymbols.has(atom.symbol));
            shuffleArray(availableAtoms);

            currentQuizAtoms = JSON.parse(JSON.stringify(availableAtoms.slice(0, NUM_QUESTIONS)));
            
            currentQuizAtoms.forEach((atom, index) => {
                atom.id = index;
                usedAtomsSymbols.add(atom.symbol);

                if (currentLevel === 'advanced') {
                    const isIon = Math.random() > 0.4; // 60% chance of being an ion
                    const possibleCharges = [-3, -2, -1, 1, 2, 3].filter(c => atom.Z - c >= 0);
                    atom.q = isIon && possibleCharges.length > 0 ? possibleCharges[Math.floor(Math.random() * possibleCharges.length)] : 0;
                } else {
                    atom.q = 0; // Nivell inicial, sempre neutre
                }

                atom.p = atom.Z;
                atom.n = atom.A - atom.Z;
                atom.e = atom.Z - atom.q;

                const possibleClues = [
                    ['Z', 'n'], ['p', 'A'], ['e', 'n'], ['Z', 'A'],
                    ['p', 'e'], ['A', 'n'], ['Z', 'q'], ['p', 'q'],
                    ['A', 'q'], ['e', 'q'], ['n', 'q']
                ];
                const randomClueIndex = Math.floor(Math.random() * possibleClues.length);
                atom.show = possibleClues[randomClueIndex];
            });
            
            generateTable(currentQuizAtoms);
            updateUIState();
        }

        function updateUIState() {
            const completedRounds = sessionHistory.length;
            
            if (completedRounds < NUM_ROUNDS) {
                statusMessage.textContent = `Ronda ${completedRounds + 1} de ${NUM_ROUNDS}`;
                reportButton.disabled = true;
                nextActionButton.classList.remove('hidden');
            } else {
                statusMessage.innerHTML = "Sessió completada! Ja pots <strong>generar l'informe</strong>.";
                reportButton.disabled = false;
                nextActionButton.classList.add('hidden');
            }
        }
        
        function generateReport(userInfo) {
            const reportView = document.getElementById('report-view');
            const levelText = currentLevel === 'advanced' ? 'Avançat (Àtoms i Ions)' : 'Inicial (Àtoms Neutres)';

            const userInfoHTML = `
                <div class="mb-6 p-4 bg-yellow-100 rounded-lg border border-yellow-300">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Dades de l'Alumne/a</h3>
                    <p class="text-gray-700"><strong>Nom:</strong> ${userInfo.name} ${userInfo.surname}</p>
                    <p class="text-gray-700"><strong>Classe:</strong> ${userInfo.class}</p>
                    <p class="text-gray-700"><strong>Nivell:</strong> ${levelText}</p>
                </div>`;

            let sessionCorrect = 0, sessionTotal = 0;
            let reportHTML = '<div class="space-y-6">';

            sessionHistory.forEach((round, index) => {
                reportHTML += `<div class="border-t pt-4 page-break-before"><h3 class="text-xl font-semibold text-gray-800 mb-3">Ronda ${index + 1}</h3><div class="space-y-4">`;
                round.attempts.forEach(element => {
                    const chargeStr = element.q > 0 ? `+${element.q}` : element.q;
                    let questionHTML = `<div class="p-3 bg-gray-100 rounded-lg"><h4 class="font-bold text-md text-gray-800">Partícula: ${element.symbol} (Z=${element.Z}, A=${element.A}, q=${chargeStr})</h4><ul class="list-disc list-inside pl-4 mt-1 text-sm">`;
                    propertyKeys.forEach(key => {
                        if (!element.show.includes(key)) {
                            sessionTotal++;
                            const userAnswer = element.userAnswers[key] || "buit";
                            const correctAnswer = String(element[key]);
                            const isCorrect = userAnswer.toLowerCase().replace(/\s/g, '').replace('+', '') === correctAnswer.toLowerCase().replace(/\s/g, '');
                            if (isCorrect) {
                                sessionCorrect++;
                                questionHTML += `<li class="correct-cell-report"><strong>${key}:</strong> Resposta "${userAnswer}" és correcta.</li>`;
                            } else {
                                questionHTML += `<li class="incorrect-cell-report break-inside-avoid"><strong>${key}:</strong> Resposta "${userAnswer}" és incorrecta (la correcta era: <strong>${correctAnswer}</strong>).</li>`;
                            }
                        }
                    });
                    questionHTML += `</ul></div>`;
                    reportHTML += questionHTML;
                });
                reportHTML += '</div></div>';
            });

            const percentage = sessionTotal > 0 ? ((sessionCorrect / sessionTotal) * 100).toFixed(1) : 0;
            let summaryHTML = `<div class="text-center mb-6"><p class="text-xl text-gray-700">Resultat total de la sessió:</p><p class="text-xl text-gray-700">Has encertat <strong>${sessionCorrect}</strong> de <strong>${sessionTotal}</strong> respostes.</p><p class="text-5xl font-bold mt-2 text-green-600">${percentage}%</p></div>`;
            
            const fullReportHTML = `
                <div id="printable-area">
                    <header class="text-center mb-8">
                        <h1 class="text-3xl sm:text-4xl font-bold text-green-800">Informe de Sessió</h1>
                    </header>
                    ${userInfoHTML}
                    ${summaryHTML}
                    ${reportHTML}</div>
                </div>
                <div class="mt-8 flex flex-col sm:flex-row flex-wrap justify-center items-center gap-4 no-print">
                    <button id="download-pdf-button-report" class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">Descarregar PDF</button>
                    <button id="restart-button-report" class="w-full sm:w-auto px-6 py-3 bg-rose-600 text-white font-semibold rounded-lg shadow-md hover:bg-rose-700 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:ring-opacity-75">Tornar a començar</button>
                </div>`;
            
            document.getElementById('quiz-view').classList.add('hidden');
            document.querySelector('header').classList.add('hidden');
            reportView.innerHTML = fullReportHTML;
            reportView.classList.remove('hidden');

            document.getElementById('download-pdf-button-report').addEventListener('click', downloadPDF);
            document.getElementById('restart-button-report').addEventListener('click', showLevelSelection);
        }

        function downloadPDF() {
            const element = document.getElementById('printable-area');
            const userName = (currentUserInfo.name || 'Alumne').replace(/\s/g, '_');
            const userSurname = (currentUserInfo.surname || '').replace(/\s/g, '_');
            const userClass = (currentUserInfo.class || 'Classe').replace(/\s/g, '_');
            
            const filename = `Informe_${userName}${userSurname}_${userClass}.pdf`;

            const opt = {
              margin:       [0.5, 0.5, 0.5, 0.5], // top, right, bottom, left
              filename:     filename,
              image:        { type: 'jpeg', quality: 0.98 },
              html2canvas:  { 
                  scale: 2, 
                  useCORS: true,
                  scrollY: 0,
                  windowHeight: element.scrollHeight,
                  letterRendering: true
              },
              jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' },
              pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
            };

            html2pdf().set(opt).from(element).save();
        }

        function saveAttempt() {
            const roundAttempts = [];
            currentQuizAtoms.forEach(element => {
                const userAnswers = {};
                propertyKeys.forEach(key => {
                    if (!element.show.includes(key)) {
                        userAnswers[key] = document.getElementById(`input-${element.id}-${key}`).value.trim();
                    }
                });
                roundAttempts.push({ ...element, userAnswers });
            });
            sessionHistory.push({ attempts: roundAttempts });
        }

        document.getElementById('level-initial').addEventListener('click', () => {
            currentLevel = 'initial';
            document.getElementById('level-selection-view').classList.add('hidden');
            document.getElementById('quiz-view').classList.remove('hidden');
            document.querySelector('header').classList.remove('hidden');
            startNewSession();
        });

        document.getElementById('level-advanced').addEventListener('click', () => {
            currentLevel = 'advanced';
            document.getElementById('level-selection-view').classList.add('hidden');
            document.getElementById('quiz-view').classList.remove('hidden');
            document.querySelector('header').classList.remove('hidden');
            startNewSession();
        });

        homeButton.addEventListener('click', showLevelSelection);

        reportButton.addEventListener('click', () => {
            userInfoModal.classList.remove('hidden');
        });

        closeUserInfoButton.addEventListener('click', () => {
            userInfoModal.classList.add('hidden');
        });
        
        userInfoForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const userInfo = {
                name: document.getElementById('user-name').value.trim(),
                surname: document.getElementById('user-surname').value.trim(),
                class: document.getElementById('user-class').value.trim()
            };
            
            if(userInfo.name && userInfo.surname && userInfo.class) {
                currentUserInfo = userInfo;
                userInfoModal.classList.add('hidden');
                generateReport(userInfo);
            } else {
                const submitButton = userInfoForm.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.textContent = 'Omple tots els camps!';
                setTimeout(() => {
                    submitButton.textContent = originalText;
                }, 2000);
            }
        });
        
        nextActionButton.addEventListener('click', () => {
            saveAttempt();
            if (sessionHistory.length < NUM_ROUNDS) {
                startNewRound();
            } else {
                updateUIState();
            }
        });

        window.onload = showLevelSelection;
    </script>
</body>
</html>

