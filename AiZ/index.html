<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activitat Interactiva: Propietats Atòmiques</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .correct-cell {
            background-color: #d1fae5 !important; /* Green-200 */
            color: #065f46; /* Green-800 */
        }
        .incorrect-cell {
            background-color: #fee2e2 !important; /* Red-200 */
            color: #991b1b; /* Red-800 */
        }
        .input-cell {
            min-width: 60px;
            max-width: 100px;
        }
        .fixed-cell {
            background-color: #f3f4f6; /* Gray-100 */
        }
        #report-modal-content {
            max-height: 70vh;
            overflow-y: auto;
        }
        button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Activitat Interactiva: Propietats Atòmiques</h1>
            <p class="mt-2 text-lg text-gray-600">Completa les 2 rondes per poder generar l'informe de la sessió.</p>
        </header>

        <main>
            <p id="status-message" class="text-center text-xl font-semibold text-gray-700 mb-4"></p>
            <div class="overflow-x-auto bg-white rounded-lg shadow">
                <table class="min-w-full divide-y divide-gray-200 text-center">
                    <thead class="bg-gray-200">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-xs sm:text-sm font-semibold text-gray-700 uppercase tracking-wider">Símbol</th>
                            <th scope="col" class="px-4 py-3 text-xs sm:text-sm font-semibold text-gray-700 uppercase tracking-wider">Nombre Atòmic (Z)</th>
                            <th scope="col" class="px-4 py-3 text-xs sm:text-sm font-semibold text-gray-700 uppercase tracking-wider">Nombre Màssic (A)</th>
                            <th scope="col" class="px-4 py-3 text-xs sm:text-sm font-semibold text-gray-700 uppercase tracking-wider">Protons (p⁺)</th>
                            <th scope="col" class="px-4 py-3 text-xs sm:text-sm font-semibold text-gray-700 uppercase tracking-wider">Neutrons (n⁰)</th>
                            <th scope="col" class="px-4 py-3 text-xs sm:text-sm font-semibold text-gray-700 uppercase tracking-wider">Electrons (e⁻)</th>
                        </tr>
                    </thead>
                    <tbody id="quiz-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Les files seran generades per JavaScript -->
                    </tbody>
                </table>
            </div>

            <div class="mt-6 flex flex-col sm:flex-row flex-wrap justify-center items-center gap-4">
                <button id="check-button" class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-transform transform hover:scale-105 disabled:hover:scale-100 disabled:hover:bg-gray-400">
                    Comprovar Respostes
                </button>
                 <button id="report-button" class="w-full sm:w-auto px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">
                    Generar Informe
                </button>
                <button id="next-action-button" class="w-full sm:w-auto px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">
                    Tornar a començar
                </button>
            </div>
        </main>
    </div>

    <!-- Finestra emergent (Modal) per a les dades de l'usuari -->
    <div id="user-info-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md transform transition-all duration-300 ease-out">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-2xl font-bold text-gray-900">Dades per a l'Informe</h2>
                <button id="close-user-info-button" class="text-gray-500 hover:text-gray-800 text-3xl font-bold leading-none">&times;</button>
            </div>
            <div class="p-6">
                <form id="user-info-form">
                    <div class="mb-4">
                        <label for="user-name" class="block text-sm font-medium text-gray-700 mb-1">Nom</label>
                        <input type="text" id="user-name" name="user-name" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="user-surname" class="block text-sm font-medium text-gray-700 mb-1">Cognom</label>
                        <input type="text" id="user-surname" name="user-surname" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="user-class" class="block text-sm font-medium text-gray-700 mb-1">Classe</label>
                        <input type="text" id="user-class" name="user-class" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75">
                            Generar Informe
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Finestra emergent (Modal) per a l'informe -->
    <div id="report-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl transform transition-all duration-300 ease-out">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-2xl font-bold text-gray-900">Informe de Sessió</h2>
                <button id="close-report-button" class="text-gray-500 hover:text-gray-800 text-3xl font-bold leading-none">&times;</button>
            </div>
            <div id="report-modal-content" class="p-6">
                <!-- El contingut de l'informe es generarà aquí -->
            </div>
        </div>
    </div>

    <script>
        const atomPool = [
            { symbol: 'H', Z: 1, A: 1 }, { symbol: 'He', Z: 2, A: 4 }, { symbol: 'Li', Z: 3, A: 7 }, { symbol: 'Be', Z: 4, A: 9 }, { symbol: 'B', Z: 5, A: 11 }, { symbol: 'C', Z: 6, A: 12 }, { symbol: 'N', Z: 7, A: 14 }, { symbol: 'O', Z: 8, A: 16 }, { symbol: 'F', Z: 9, A: 19 }, { symbol: 'Ne', Z: 10, A: 20 }, { symbol: 'Na', Z: 11, A: 23 }, { symbol: 'Mg', Z: 12, A: 24 }, { symbol: 'Al', Z: 13, A: 27 }, { symbol: 'Si', Z: 14, A: 28 }, { symbol: 'P', Z: 15, A: 31 }, { symbol: 'S', Z: 16, A: 32 }, { symbol: 'Cl', Z: 17, A: 35 }, { symbol: 'Ar', Z: 18, A: 40 }, { symbol: 'K', Z: 19, A: 39 }, { symbol: 'Ca', Z: 20, A: 40 },
            { symbol: 'Sc', Z: 21, A: 45 }, { symbol: 'Ti', Z: 22, A: 48 }, { symbol: 'V', Z: 23, A: 51 }, { symbol: 'Cr', Z: 24, A: 52 }, { symbol: 'Mn', Z: 25, A: 55 }, { symbol: 'Fe', Z: 26, A: 56 }, { symbol: 'Co', Z: 27, A: 59 }, { symbol: 'Ni', Z: 28, A: 58 }, { symbol: 'Cu', Z: 29, A: 63 }, { symbol: 'Zn', Z: 30, A: 65 }
        ];

        atomPool.forEach(atom => {
            atom.p = atom.Z; atom.e = atom.Z; atom.n = atom.A - atom.Z;
        });

        const tableBody = document.getElementById('quiz-table-body');
        const checkButton = document.getElementById('check-button');
        const nextActionButton = document.getElementById('next-action-button');
        const reportButton = document.getElementById('report-button');
        const reportModal = document.getElementById('report-modal');
        const reportModalContent = document.getElementById('report-modal-content');
        const closeReportButton = document.getElementById('close-report-button');
        const statusMessage = document.getElementById('status-message');
        const userInfoModal = document.getElementById('user-info-modal');
        const userInfoForm = document.getElementById('user-info-form');
        const closeUserInfoButton = document.getElementById('close-user-info-button');
        
        const propertyKeys = ['symbol', 'Z', 'A', 'p', 'n', 'e'];
        const NUM_QUESTIONS = 5;
        const NUM_ROUNDS = 2;
        let currentQuizAtoms = [];
        let sessionHistory = [];
        let usedAtomsSymbols = new Set();

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function generateTable(atoms) {
            tableBody.innerHTML = '';
            atoms.forEach(element => {
                const row = document.createElement('tr');
                row.id = `row-${element.id}`;
                propertyKeys.forEach(key => {
                    const cell = document.createElement('td');
                    cell.classList.add('px-4', 'py-3', 'text-sm', 'whitespace-nowrap');
                    if (element.show.includes(key)) {
                        cell.textContent = element[key];
                        cell.classList.add('font-medium', 'text-gray-900', 'fixed-cell');
                    } else {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.id = `input-${element.id}-${key}`;
                        input.classList.add('w-full', 'p-2', 'text-center', 'border', 'border-gray-300', 'rounded-md', 'focus:ring-blue-500', 'focus:border-blue-500', 'input-cell');
                        cell.appendChild(input);
                    }
                    row.appendChild(cell);
                });
                tableBody.appendChild(row);
            });
        }
        
        function startNewSession() {
            sessionHistory = [];
            usedAtomsSymbols = new Set();
            startNewRound();
        }

        function startNewRound() {
            clearFeedback();
            reportModal.classList.add('hidden');
            // Eliminem les pistes que inclouen el símbol per obligar a deduir-lo
            const possibleClues = [['Z', 'n'], ['p', 'A'], ['e', 'n'], ['Z', 'A'], ['p', 'e'], ['A', 'n']];
            
            const availableAtoms = atomPool.filter(atom => !usedAtomsSymbols.has(atom.symbol));
            shuffleArray(availableAtoms);

            currentQuizAtoms = JSON.parse(JSON.stringify(availableAtoms.slice(0, NUM_QUESTIONS)));
            currentQuizAtoms.forEach((atom, index) => {
                atom.id = index;
                usedAtomsSymbols.add(atom.symbol);
                const randomClueIndex = Math.floor(Math.random() * possibleClues.length);
                atom.show = possibleClues[randomClueIndex];
            });
            
            generateTable(currentQuizAtoms);
            updateUIState();
        }

        function updateUIState() {
            const completedRounds = sessionHistory.length;
            
            if (completedRounds < NUM_ROUNDS) {
                statusMessage.textContent = `Ronda ${completedRounds + 1} de ${NUM_ROUNDS}`;
                checkButton.disabled = false;
                reportButton.disabled = true;
                nextActionButton.textContent = 'Següent Ronda';
                nextActionButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                nextActionButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            } else {
                statusMessage.textContent = "Sessió completada! Ja pots generar l'informe.";
                checkButton.disabled = true;
                reportButton.disabled = false;
                nextActionButton.textContent = 'Tornar a començar';
                nextActionButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                nextActionButton.classList.add('bg-red-600', 'hover:bg-red-700');
            }
        }
        
        function clearFeedback() {
            const inputs = tableBody.querySelectorAll('input');
            inputs.forEach(input => input.classList.remove('correct-cell', 'incorrect-cell'));
        }
        
        function generateReport(userInfo) {
            if (sessionHistory.length < NUM_ROUNDS) {
                reportModalContent.innerHTML = `<p class="text-center text-gray-600">Has de completar les ${NUM_ROUNDS} rondes per generar l'informe.</p>`;
                reportModal.classList.remove('hidden');
                return;
            }

            const userInfoHTML = `
                <div class="mb-6 p-4 bg-gray-100 rounded-lg border border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Dades de l'Alumne/a</h3>
                    <p class="text-gray-700"><strong>Nom:</strong> ${userInfo.name} ${userInfo.surname}</p>
                    <p class="text-gray-700"><strong>Classe:</strong> ${userInfo.class}</p>
                </div>`;

            let sessionCorrect = 0, sessionTotal = 0;
            let reportHTML = '<div class="space-y-6">';

            sessionHistory.forEach((round, index) => {
                reportHTML += `<div class="border-t pt-4"><h3 class="text-xl font-semibold text-gray-800 mb-3">Ronda ${index + 1}</h3><div class="space-y-4">`;
                round.attempts.forEach(element => {
                    let questionHTML = `<div class="p-3 bg-gray-50 rounded-lg"><h4 class="font-bold text-md text-gray-800">Element (Z=${element.Z})</h4><ul class="list-disc list-inside pl-4 mt-1 text-sm">`;
                    propertyKeys.forEach(key => {
                        if (!element.show.includes(key)) {
                            sessionTotal++;
                            const userAnswer = element.userAnswers[key] || "buit";
                            const correctAnswer = String(element[key]);
                            if (userAnswer.toLowerCase().replace(/\s/g, '') === correctAnswer.toLowerCase().replace(/\s/g, '')) {
                                sessionCorrect++;
                                questionHTML += `<li class="text-green-700"><strong>${key}:</strong> Resposta "${userAnswer}" és correcta.</li>`;
                            } else {
                                questionHTML += `<li class="text-red-700"><strong>${key}:</strong> Resposta "${userAnswer}" és incorrecta (la correcta era: <strong>${correctAnswer}</strong>).</li>`;
                            }
                        }
                    });
                    questionHTML += `</ul></div>`;
                    reportHTML += questionHTML;
                });
                reportHTML += '</div></div>';
            });

            const percentage = sessionTotal > 0 ? ((sessionCorrect / sessionTotal) * 100).toFixed(1) : 0;
            let summaryHTML = `<div class="text-center mb-6"><p class="text-xl text-gray-700">Resultat total de la sessió:</p><p class="text-xl text-gray-700">Has encertat <strong>${sessionCorrect}</strong> de <strong>${sessionTotal}</strong> respostes.</p><p class="text-5xl font-bold mt-2 text-purple-600">${percentage}%</p></div>`;
            reportModalContent.innerHTML = userInfoHTML + summaryHTML + reportHTML + '</div>';
            reportModal.classList.remove('hidden');
        }

        function saveAttempt() {
            const roundAttempts = [];
            currentQuizAtoms.forEach(element => {
                const userAnswers = {};
                propertyKeys.forEach(key => {
                    if (!element.show.includes(key)) {
                        userAnswers[key] = document.getElementById(`input-${element.id}-${key}`).value.trim();
                    }
                });
                roundAttempts.push({ ...element, userAnswers });
            });
            sessionHistory.push({ attempts: roundAttempts });
        }

        checkButton.addEventListener('click', () => {
            clearFeedback();
            currentQuizAtoms.forEach(element => {
                propertyKeys.forEach(key => {
                    if (!element.show.includes(key)) {
                        const input = document.getElementById(`input-${element.id}-${key}`);
                        if (input.value.trim().toLowerCase().replace(/\s/g, '') === String(element[key]).toLowerCase().replace(/\s/g, '')) {
                            input.classList.add('correct-cell');
                        } else {
                            input.classList.add('incorrect-cell');
                        }
                    }
                });
            });
        });

        reportButton.addEventListener('click', () => {
            userInfoModal.classList.remove('hidden');
        });

        closeUserInfoButton.addEventListener('click', () => {
            userInfoModal.classList.add('hidden');
        });
        
        userInfoForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const userInfo = {
                name: document.getElementById('user-name').value.trim(),
                surname: document.getElementById('user-surname').value.trim(),
                class: document.getElementById('user-class').value.trim()
            };
            
            if(userInfo.name && userInfo.surname && userInfo.class) {
                userInfoModal.classList.add('hidden');
                generateReport(userInfo);
            } else {
                alert("Si us plau, omple tots els camps.");
            }
        });
        
        closeReportButton.addEventListener('click', () => reportModal.classList.add('hidden'));
        
        nextActionButton.addEventListener('click', () => {
            if (nextActionButton.textContent === 'Següent Ronda') {
                saveAttempt();
                if (sessionHistory.length < NUM_ROUNDS) {
                    startNewRound();
                } else {
                    updateUIState();
                }
            } else { // 'Tornar a començar'
                startNewSession();
            }
        });

        window.onload = startNewSession;
    </script>
</body>
</html>

