<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrevista amb Cient√≠fics At√≤mics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0f9ff; /* bg-sky-50 */
        }
        .chat-bubble {
            max-width: 80%;
            padding: 12px 20px;
            word-wrap: break-word;
        }
        .chat-bubble p { margin-bottom: 0.5rem; }
        .chat-bubble p:last-child { margin-bottom: 0; }
        .chat-bubble ul { margin-top: 0.5rem; margin-left: 1rem; list-style-type: disc; }
        .chat-bubble a {
            color: #0284c7; /* sky-600 */
            font-weight: 700;
            text-decoration: underline;
        }
        .chat-bubble a:hover {
            color: #0369a1; /* sky-700 */
        }
        .chat-bubble-user {
            background-color: #0ea5e9; /* bg-sky-500 */
            color: white;
            border-radius: 24px 24px 8px 24px;
            align-self: flex-end;
        }
        .chat-bubble-ai {
            background-color: #e2e8f0; /* bg-slate-200 */
            color: #1e293b; /* bg-slate-800 */
            border-radius: 24px 24px 24px 8px;
            align-self: flex-start;
        }
        .image-container {
            align-self: flex-start;
            margin-top: 8px;
            max-width: 80%;
            background-color: #e2e8f0;
            border-radius: 24px;
            padding: 8px;
        }
        .image-container img {
            border-radius: 18px;
            max-width: 100%;
            height: auto;
        }
        #messages::-webkit-scrollbar { width: 8px; }
        #messages::-webkit-scrollbar-track { background: transparent; }
        #messages::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        
        :fullscreen, ::-webkit-full-screen {
            background-color: #f0f9ff;
        }
        #main-container:fullscreen, #main-container::-webkit-full-screen {
            height: 100vh;
            width: 100vw;
            border-radius: 0;
            max-width: none;
            box-shadow: none;
        }
        .quiz-loader {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-2 sm:p-4">

    <div id="main-container" class="w-full max-w-3xl mx-auto bg-white rounded-3xl shadow-2xl flex flex-col h-[95vh] sm:h-[90vh] transition-all duration-300 overflow-hidden">
        <!-- Header -->
        <header class="flex justify-between items-center p-4 border-b-4 border-sky-100">
            <div class="flex items-center gap-3">
                 <button id="fullscreen-btn" title="Maximitzar/Minimitzar" class="text-gray-400 hover:text-sky-500 transition-colors">
                    <svg id="fullscreen-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
                    <svg id="minimize-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path></svg>
                </button>
                <h1 id="main-title" class="text-xl md:text-2xl font-extrabold text-slate-700">Entrevista amb Cient√≠fics</h1>
            </div>
            <div class="flex items-center gap-4">
                 <button id="quiz-btn" class="bg-amber-400 hover:bg-amber-500 text-white font-bold py-2 px-4 rounded-full flex items-center gap-2 transition-transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                    <span id="quiz-btn-text" class="hidden sm:inline">Comprova el que has apr√®s</span>
                </button>
                <div class="flex items-center space-x-1 bg-slate-100 p-1 rounded-full">
                    <button id="lang-ca" class="px-3 py-1 text-sm font-bold rounded-full">CAT</button>
                    <button id="lang-es" class="px-3 py-1 text-sm font-bold rounded-full">ES</button>
                </div>
            </div>
        </header>

        <!-- Scientist Selector -->
        <div class="p-4 bg-slate-50 border-b border-slate-200">
            <label for="scientist-select" id="select-label" class="block mb-2 text-sm font-bold text-slate-500">Tria un cient√≠fic per comen√ßar:</label>
            <select id="scientist-select" class="bg-white border-2 border-slate-200 text-slate-800 font-semibold text-base rounded-lg focus:ring-sky-500 focus:border-sky-500 block w-full p-3 transition-colors">
                <option id="select-option-default" value="">-- Selecciona una opci√≥ --</option>
                <option value="dalton">üë®üèª‚Äçüî¨ John Dalton</option>
                <option value="thomson">üë®üèº‚Äçüî¨ J.J. Thomson</option>
                <option value="rutherford">üë®üèΩ‚Äçüî¨ Ernest Rutherford</option>
                <option value="bohr">üë®üèæ‚Äçüî¨ Niels Bohr</option>
                <option id="select-option-conclusion" value="conclusion">‚úçÔ∏è La meva Conclusi√≥</option>
            </select>
        </div>

        <!-- Chat Container -->
        <div id="chat-container" class="flex-1 flex flex-col p-4 overflow-hidden hidden bg-white">
            <div id="messages" class="flex-1 flex flex-col space-y-4 overflow-y-auto pr-2"></div>
            <div id="loading" class="self-start p-2 hidden">
                <div class="flex items-center justify-center space-x-2">
                    <div class="w-2.5 h-2.5 rounded-full bg-sky-500 animate-pulse [animation-delay:-0.3s]"></div>
                    <div class="w-2.5 h-2.5 rounded-full bg-sky-500 animate-pulse [animation-delay:-0.15s]"></div>
                    <div class="w-2.5 h-2.5 rounded-full bg-sky-500 animate-pulse"></div>
                </div>
            </div>
            <div class="pt-4 border-t border-slate-100">
                <form id="chat-form" class="flex items-center gap-3">
                    <input type="text" id="chat-input" class="flex-1 bg-slate-100 border-2 border-transparent rounded-full py-3 px-5 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-transparent transition-all" placeholder="Escriu la teva pregunta...">
                    <button type="submit" id="send-button" class="bg-sky-500 hover:bg-sky-600 text-white font-bold p-3 rounded-full flex items-center justify-center transition-transform hover:scale-110">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send -rotate-12"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </form>
            </div>
        </div>

        <!-- Conclusion Container -->
        <div id="conclusion-container" class="flex-1 p-6 overflow-y-auto hidden bg-slate-50">
            <h2 id="conclusion-title" class="text-2xl font-extrabold text-sky-600 mb-4">L'evoluci√≥ de l'√Ätom: La teva Conclusi√≥</h2>
            <p id="conclusion-intro" class="text-slate-600 mb-6">Despr√©s de parlar amb aquests pioners, √©s el teu torn de reflexionar. Com ha canviat la nostra comprensi√≥ de la mat√®ria? Utilitza les preguntes seg√ºents com a guia per escriure una breu conclusi√≥.</p>
            <div class="space-y-4">
                <div class="bg-white p-4 rounded-xl border border-slate-200">
                    <p id="conclusion-q1" class="font-semibold text-slate-700">üí° Com va canviar la idea de l'√†tom des de la simple esfera de Dalton fins al model de Bohr?</p>
                </div>
                 <div class="bg-white p-4 rounded-xl border border-slate-200">
                    <p id="conclusion-q2" class="font-semibold text-slate-700">üî¨ Quina import√†ncia tenen els experiments (com el de la l√†mina d'or) en el progr√©s cient√≠fic?</p>
                </div>
                 <div class="bg-white p-4 rounded-xl border border-slate-200">
                    <p id="conclusion-q3" class="font-semibold text-slate-700">ü§î Per qu√® creus que un model cient√≠fic √©s reempla√ßat per un altre en lloc de ser simplement descartat?</p>
                </div>
            </div>
            <textarea id="conclusion-textarea" rows="8" class="mt-6 w-full bg-white border-2 border-slate-200 rounded-xl p-4 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Escriu aqu√≠ la teva reflexi√≥..."></textarea>
        </div>
        
        <!-- Initial Message -->
        <div id="initial-message" class="flex-1 flex flex-col items-center justify-center text-center p-6 bg-white">
             <div id="initial-loading" class="flex items-center justify-center space-x-2">
                <div class="w-3 h-3 rounded-full bg-sky-500 animate-pulse [animation-delay:-0.3s]"></div>
                <div class="w-3 h-3 rounded-full bg-sky-500 animate-pulse [animation-delay:-0.15s]"></div>
                <div class="w-3 h-3 rounded-full bg-sky-500 animate-pulse"></div>
            </div>
             <div id="initial-content" class="hidden">
                <svg class="w-20 h-20 mx-auto mb-4 text-sky-400" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 25.6667C20.4434 25.6667 25.6667 20.4434 25.6667 14C25.6667 7.55663 20.4434 2.33334 14 2.33334C7.55663 2.33334 2.33334 7.55663 2.33334 14C2.33334 20.4434 7.55663 25.6667 14 25.6667Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21.2882 17.0333C21.0432 17.7583 20.6832 18.4383 20.2232 19.0483M6.71153 17.0333C6.95653 17.7583 7.31653 18.4383 7.77653 19.0483M11.6667 21.2333C12.3534 21.5033 13.1234 21.6667 13.9984 21.6667C14.8734 21.6667 15.6434 21.5033 16.3317 21.2333M23.3334 11.6667C20.5334 10.0333 7.46671 10.0333 4.66671 11.6667" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <div id="initial-text-container" class="text-slate-600 text-lg"></div>
             </div>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div id="quiz-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6">
            <h2 id="quiz-title" class="text-2xl font-bold text-slate-800 mb-4">Comprova el que has apr√®s</h2>
            <div id="quiz-content" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <!-- Quiz questions will be injected here -->
            </div>
            <div id="quiz-result" class="mt-4 font-bold"></div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="quiz-close-btn" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-semibold hover:bg-slate-300">Tancar</button>
                <button id="quiz-check-btn" class="px-4 py-2 bg-sky-500 text-white rounded-lg font-semibold hover:bg-sky-600">Verifica</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const mainContainer = document.getElementById('main-container');
            const scientistSelect = document.getElementById('scientist-select');
            const chatContainer = document.getElementById('chat-container');
            const conclusionContainer = document.getElementById('conclusion-container');
            const initialMessage = document.getElementById('initial-message');
            const initialLoading = document.getElementById('initial-loading');
            const initialContent = document.getElementById('initial-content');
            const initialTextContainer = document.getElementById('initial-text-container');
            const messagesDiv = document.getElementById('messages');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const loadingDiv = document.getElementById('loading');
            const langCaButton = document.getElementById('lang-ca');
            const langEsButton = document.getElementById('lang-es');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const fullscreenIcon = document.getElementById('fullscreen-icon');
            const minimizeIcon = document.getElementById('minimize-icon');
            const quizBtn = document.getElementById('quiz-btn');
            const quizModal = document.getElementById('quiz-modal');
            const quizTitle = document.getElementById('quiz-title');
            const quizContent = document.getElementById('quiz-content');
            const quizResult = document.getElementById('quiz-result');
            const quizCloseBtn = document.getElementById('quiz-close-btn');
            const quizCheckBtn = document.getElementById('quiz-check-btn');

            // App state
            let currentLang = 'ca';
            let currentScientist = null;
            let chatHistory = [];
            let pendingImageOfferUrl = null;
            let currentQuizQuestions = [];
            const markdownConverter = new showdown.Converter();

            // --- TRANSLATIONS AND DATA ---
            const translations = {
                ca: {
                    mainTitle: "Entrevista amb Cient√≠fics",
                    selectLabel: "Tria un cient√≠fic per comen√ßar:",
                    selectOptionDefault: "-- Selecciona una opci√≥ --",
                    selectOptionConclusion: "‚úçÔ∏è La meva Conclusi√≥",
                    chatPlaceholder: "Escriu la teva pregunta...",
                    conclusionTitle: "L'evoluci√≥ de l'√Ätom: La teva Conclusi√≥",
                    conclusionIntro: "Despr√©s de parlar amb aquests pioners, √©s el teu torn de reflexionar. Com ha canviat la nostra comprensi√≥ de la mat√®ria gr√†cies a les seves contribucions successives? Utilitza les preguntes seg√ºents com a guia per escriure una breu conclusi√≥.",
                    conclusionQ1: "üí° Com va canviar la idea de l'√†tom des de la simple esfera de Dalton fins al model de Bohr?",
                    conclusionQ2: "üî¨ Quina import√†ncia tenen els experiments (com el de la l√†mina d'or) en el progr√©s cient√≠fic?",
                    conclusionQ3: "ü§î Per qu√® creus que un model cient√≠fic √©s reempla√ßat per un altre en lloc de ser simplement descartat?",
                    conclusionTextarea: "Escriu aqu√≠ la teva reflexi√≥...",
                    initialGreetingPrompt: "Ets un assistent virtual divertit i engrescador per a una activitat educativa. Saluda en catal√† a estudiants de secund√†ria. Fes una pregunta breu i interessant sobre els √†toms per despertar la seva curiositat i anima'ls a triar un cient√≠fic de la llista per comen√ßar una 'entrevista'. Utilitza un to proper i amigable.",
                    apiError: "Vaja! Sembla que hi ha una interfer√®ncia en la l√≠nia temporal... Podries repetir la pregunta?",
                    apiEmptyResponse: "M'he quedat en blanc, com un √†tom sense electrons! Prova de nou.",
                    quizTitle: "Comprova el que has apr√®s",
                    quizCheckBtn: "Verifica",
                    quizCloseBtn: "Tancar",
                    quizResultCorrect: "Molt b√©! Totes les respostes s√≥n correctes.",
                    quizResultIncorrect: "Algunes respostes no s√≥n correctes. Revisa-les!",
                    quizGenerating: "Un moment, estic preparant les teves preguntes...",
                    quizBtnText: "Comprova el que has apr√®s",
                },
                es: {
                    mainTitle: "Entrevista con Cient√≠ficos",
                    selectLabel: "Elige un cient√≠fico para empezar:",
                    selectOptionDefault: "-- Selecciona una opci√≥n --",
                    selectOptionConclusion: "‚úçÔ∏è Mi Conclusi√≥n",
                    chatPlaceholder: "Escribe tu pregunta...",
                    conclusionTitle: "La evoluci√≥n del √Åtomo: Tu Conclusi√≥n",
                    conclusionIntro: "Despu√©s de hablar con estos pioneros, es tu turno de reflexionar. ¬øC√≥mo ha cambiado nuestra comprensi√≥n de la materia gracias a sus sucesivas contribuciones? Utiliza las siguientes preguntas como gu√≠a para escribir una breve conclusi√≥n.",
                    conclusionQ1: "üí° ¬øC√≥mo cambi√≥ la idea del √°tomo desde la simple esfera de Dalton hasta el modelo de Bohr?",
                    conclusionQ2: "üî¨ ¬øQu√© importancia tienen los experimentos (como el de la l√°mina de oro) en el progreso cient√≠fico?",
                    conclusionQ3: "¬øPor qu√© crees que un modelo cient√≠fico es reemplazado por otro en lugar de ser simplemente descartado?",
                    conclusionTextarea: "Escribe aqu√≠ tu reflexi√≥n...",
                    initialGreetingPrompt: "Eres un asistente virtual divertido y motivador para una actividad educativa. Saluda en espa√±ol a estudiantes de secundaria. Haz una pregunta breve e interesante sobre los √°tomos para despertar su curiosidad y an√≠males a elegir un cient√≠fico de la lista para empezar una 'entrevista'. Usa un tono cercano y amigable.",
                    apiError: "¬°Vaya! Parece que hay una interferencia en la l√≠nea temporal... ¬øPodr√≠as repetir la pregunta?",
                    apiEmptyResponse: "¬°Me he quedado en blanco, como un √°tomo sin electrones! Int√©ntalo de nuevo.",
                    quizTitle: "Comprueba lo que has aprendido",
                    quizCheckBtn: "Verifica",
                    quizCloseBtn: "Cerrar",
                    quizResultCorrect: "¬°Muy bien! Todas las respuestas son correctas.",
                    quizResultIncorrect: "Algunas respuestas no son correctas. ¬°Rep√°salas!",
                    quizGenerating: "Un momento, estoy preparando tus preguntas...",
                    quizBtnText: "Comprueba lo aprendido",
                }
            };
            
            const imageBaseUrl = "https://montcubi.github.io/imatges/models_atomics/";

            const scientistData = {
                dalton: {
                    name: "John Dalton",
                    introPrompt: { ca: "ACTUA com a John Dalton. Saluda en catal√† un estudiant de 15 anys tractant-lo de 'tu'. La teva salutaci√≥ ha de ser breu, amable i mencionar la teva teoria at√≤mica.", es: "ACT√öA como John Dalton. Saluda en espa√±ol a un estudiante de 15 a√±os trat√°ndolo de 't√∫'. Tu saludo debe ser breve, amable y mencionar tu teor√≠a at√≥mica." },
                    persona: {
                        ca: `REGLA D'OR: Has d'actuar SEMPRE com a John Dalton. Parla en catal√† i tracta l'estudiant de 'tu'. El teu to √©s el d'un mestre pacient. Fes servir explicacions senzilles i molt concises (M√ÄXIM 100 PARAULES). Si parles del teu model, pregunta si vol veure un esquema amb l'etiqueta [OFEREIX_IMATGE:${imageBaseUrl}08.png]. De tant en tant, si la conversa s'atura, pots suggerir preguntes com: 'Potser et preguntes sobre els meus postulats, o com vaig arribar a aquestes conclusions.'`,
                        es: `REGLA DE ORO: Tienes que actuar SIEMPRE como John Dalton. Habla en espa√±ol y trata al estudiante de 't√∫'. Tu tono es el de un maestro paciente. Usa explicaciones sencillas y muy concisas (M√ÅXIMO 100 PALABRAS). Si hablas de tu modelo, pregunta si quiere ver un esquema con la etiqueta [OFEREIX_IMATGE:${imageBaseUrl}08.png]. De vez en cuando, si la conversaci√≥n se detiene, puedes sugerir preguntas como: 'Quiz√°s te preguntas sobre mis postulados, o c√≥mo llegu√© a estas conclusiones.'`
                    }
                },
                thomson: {
                    name: "J.J. Thomson",
                    introPrompt: { ca: "ACTUA com a J.J. Thomson. Saluda en catal√† un estudiant de 15 anys tractant-lo de 'tu'. La teva salutaci√≥ ha de ser breu, una mica formal i mostrar orgull pel descobriment de l'electr√≥.", es: "ACT√öA como J.J. Thomson. Saluda en espa√±ol a un estudiante de 15 a√±os trat√°ndolo de 't√∫'. Tu saludo debe ser breve, un poco formal y mostrar orgullo por el descubrimiento del electr√≥n." },
                    persona: {
                        ca: `REGLA D'OR: Has d'actuar SEMPRE com a J.J. Thomson. Parla en catal√† i tracta l'estudiant de 'tu'. El teu to √©s el d'un professor de Cambridge, orgull√≥s per√≤ proper. Respon de manera concisa (M√ÄXIM 100 PARAULES). Si parles del teu model, pregunta si vol veure'l amb l'etiqueta [OFEREIX_IMATGE:${imageBaseUrl}10.png]. Si parles de l'experiment amb raigs cat√≤dics, ofereix-li una imatge amb [OFEREIX_IMATGE:${imageBaseUrl}03.png]. De tant en tant, pots suggerir preguntes com: 'Podr√≠em parlar del meu experiment, o de per qu√® el meu model es diu 'p√∫ding de panses'.'`,
                        es: `REGLA DE ORO: Tienes que actuar SIEMPRE como J.J. Thomson. Habla en espa√±ol y trata al estudiante de 't√∫'. Tu tono es el de un profesor de Cambridge, orgulloso pero cercano. Responde de forma concisa (M√ÅXIMO 100 PALABRAS). Si hablas de tu modelo, pregunta si quiere verlo con la etiqueta [OFEREIX_IMATGE:${imageBaseUrl}10.png]. Si hablas del experimento con rayos cat√≥dicos, ofr√©cele una imagen con [OFEREIX_IMATGE:${imageBaseUrl}03.png]. De vez en cuando, puedes sugerir preguntas como: 'Podr√≠amos hablar de mi experimento, o de por qu√© mi modelo se llama 'pudin de pasas'.'`
                    }
                },
                rutherford: {
                    name: "Ernest Rutherford",
                    introPrompt: { ca: "ACTUA com a Ernest Rutherford. Saluda en catal√† un estudiant de 15 anys tractant-lo de 'tu'. La teva salutaci√≥ ha de ser breu, en√®rgica i transmetre l'emoci√≥ del teu fam√≥s experiment.", es: "ACT√öA como Ernest Rutherford. Saluda en espa√±ol a un estudiante de 15 a√±os trat√°ndolo de 't√∫'. Tu saludo debe ser breve, en√©rgico y transmitir la emoci√≥n de tu famoso experimento." },
                    persona: {
                        ca: `REGLA D'OR: Has d'actuar SEMPRE com a Ernest Rutherford. Parla en catal√† i tracta l'estudiant de 'tu'. El teu to √©s entusiasta i directe. Explica les coses amb passi√≥ de manera concisa (M√ÄXIM 100 PARAULES). Si parles del teu model, ofereix-li una imatge amb [OFEREIX_IMATGE:${imageBaseUrl}09.png]. Si parles de l'experiment, ofereix-li una imatge amb [OFEREIX_IMATGE:${imageBaseUrl}05.png]. Emfatitza la idea de l'espai buit i l'escor√ßa. De tant en tant, pots suggerir-li preguntes com: 'Vols que parlem de la l√†mina d'or, del nucli at√≤mic o de l'escor√ßa?'`,
                        es: `REGLA DE ORO: Tienes que actuar SIEMPRE como Ernest Rutherford. Habla en espa√±ol y trata al estudiante de 't√∫'. Tu tono es entusiasta y directo. Explica las cosas con pasi√≥n de forma concisa (M√ÅXIMO 100 PALABRAS). Si hablas de tu modelo, ofr√©cele una imagen con [OFEREIX_IMATGE:${imageBaseUrl}09.png]. Si hablas del experimento, ofr√©cele una imagen con [OFEREIX_IMATGE:${imageBaseUrl}05.png]. Enfatiza la idea del espacio vac√≠o y la corteza. De vez en cuando, puedes sugerirle preguntas como: '¬øQuieres que hablemos de la l√°mina de oro, del n√∫cleo at√≥mico o de la corteza?'`
                    }
                },
                bohr: {
                    name: "Niels Bohr",
                    introPrompt: { ca: "ACTUA com a Niels Bohr. Saluda en catal√† un estudiant de 15 anys tractant-lo de 'tu'. La teva salutaci√≥ ha de ser breu, reflexiva i mencionar com vas millorar el model de Rutherford.", es: "ACT√öA como Niels Bohr. Saluda en espa√±ol a un estudiante de 15 a√±os trat√°ndolo de 't√∫'. Tu saludo debe ser breve, reflexivo y mencionar c√≥mo mejoraste el modelo de Rutherford." },
                    persona: {
                        ca: `REGLA D'OR: Has d'actuar SEMPRE com a Niels Bohr. Parla en catal√† i tracta l'estudiant de 'tu'. El teu to √©s m√©s te√≤ric i reflexiu. Respon de manera concisa (M√ÄXIM 100 PARAULES). Si parles del teu model, ofereix-li una imatge amb l'etiqueta [OFEREIX_IMATGE:${imageBaseUrl}07.png]. De tant en tant, pots suggerir-li preguntes com: 'Podem aprofundir en les √≤rbites permeses, els salts qu√†ntics o els espectres at√≤mics.'`,
                        es: `REGLA DE ORO: Tienes que actuar SIEMPRE como Niels Bohr. Habla en espa√±ol y trata al estudiante de 't√∫'. Tu tono es m√°s te√≥rico y reflexivo. Responde de forma concisa (M√ÅXIMO 100 PALABRAS). Si hablas de tu modelo, ofr√©cele una imagen con la etiqueta [OFEREIX_IMATGE:${imageBaseUrl}07.png]. De vez en cuando, puedes sugerirle preguntas como: 'Podemos profundizar en las √≥rbitas permitidas, los saltos cu√°nticos o los espectros at√≥micos.'`
                    }
                }
            };
            
            // --- API FUNCTIONS ---
            async function callGemini(history, jsonSchema = null) {
                const payload = { contents: history };
                if (jsonSchema) {
                    payload.generationConfig = {
                        responseMimeType: "application/json",
                        responseSchema: jsonSchema
                    };
                }
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]) {
                    return result.candidates[0].content.parts[0].text;
                }
                return null;
            }

            // --- UI FUNCTIONS ---
            function setLanguage(lang) {
                currentLang = lang;
                document.documentElement.lang = lang;
                const t = translations[lang];

                if (lang === 'ca') {
                    langCaButton.classList.add('bg-white', 'text-sky-600');
                    langCaButton.classList.remove('text-slate-500');
                    langEsButton.classList.remove('bg-white', 'text-sky-600');
                    langEsButton.classList.add('text-slate-500');
                } else {
                    langEsButton.classList.add('bg-white', 'text-sky-600');
                    langEsButton.classList.remove('text-slate-500');
                    langCaButton.classList.remove('bg-white', 'text-sky-600');
                    langCaButton.classList.add('text-slate-500');
                }

                document.getElementById('main-title').innerText = t.mainTitle;
                document.getElementById('select-label').innerText = t.selectLabel;
                document.getElementById('select-option-default').innerText = t.selectOptionDefault;
                document.getElementById('select-option-conclusion').innerHTML = t.selectOptionConclusion;
                document.getElementById('chat-input').placeholder = t.chatPlaceholder;
                document.getElementById('conclusion-title').innerText = t.conclusionTitle;
                document.getElementById('conclusion-intro').innerText = t.conclusionIntro;
                document.querySelector('#conclusion-q1').innerHTML = t.conclusionQ1;
                document.querySelector('#conclusion-q2').innerHTML = t.conclusionQ2;
                document.querySelector('#conclusion-q3').innerHTML = t.conclusionQ3;
                document.getElementById('conclusion-textarea').placeholder = t.conclusionTextarea;
                quizTitle.innerText = t.quizTitle;
                quizCheckBtn.innerText = t.quizCheckBtn;
                quizCloseBtn.innerText = t.quizCloseBtn;
                document.getElementById('quiz-btn-text').innerText = t.quizBtnText;
                
                if (currentScientist && currentScientist !== 'conclusion') {
                   handleScientistChange({ target: { value: currentScientist } });
                } else {
                    getInitialGreeting();
                }
            }
            
            function displayMessage(text, sender) {
                const bubble = document.createElement('div');
                bubble.classList.add('chat-bubble', sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai');
                bubble.innerHTML = markdownConverter.makeHtml(text);
                messagesDiv.appendChild(bubble);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            function displayImage(url) {
                const container = document.createElement('div');
                container.className = 'image-container';
                const img = document.createElement('img');
                img.src = url;
                img.alt = "Il¬∑lustraci√≥ del model at√≤mic";
                img.onerror = () => { container.innerHTML = `<p class="text-xs text-red-500">No s'ha pogut carregar la imatge.</p>`; };
                container.appendChild(img);
                messagesDiv.appendChild(container);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
            
            function processAndDisplayAiResponse(text) {
                const offerRegex = /\[OFEREIX_IMATGE:(.*?)\]/g;
                const match = offerRegex.exec(text);
                const cleanText = text.replace(offerRegex, '').trim();

                if (cleanText) {
                    displayMessage(cleanText, 'ai');
                }

                if (match && match[1]) {
                    pendingImageOfferUrl = match[1];
                }
            }

            // --- QUIZ FUNCTIONS ---
            async function openQuizModal() {
                quizModal.classList.remove('hidden');
                quizContent.innerHTML = `<div class="flex flex-col items-center"><div class="quiz-loader"></div><p class="mt-2 text-slate-500">${translations[currentLang].quizGenerating}</p></div>`;
                quizResult.innerHTML = '';
                quizCheckBtn.disabled = true;
                quizCheckBtn.onclick = checkQuizAnswers; // Reset action

                const langName = currentLang === 'ca' ? 'catal√†' : 'espa√±ol';
                const quizPrompt = `Genera un q√ºestionari de 10 preguntes de tipus test sobre els models at√≤mics de Dalton, Thomson, Rutherford i Bohr. Les preguntes han de ser variades, per a estudiants de 15 anys. L'idioma ha de ser ${langName}. Retorna un JSON.`;
                const schema = {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            q: { type: "STRING" },
                            o: { type: "ARRAY", items: { type: "STRING" } },
                            a: { type: "INTEGER" }
                        },
                        required: ["q", "o", "a"]
                    }
                };

                try {
                    const jsonString = await callGemini([{ role: 'user', parts: [{ text: quizPrompt }] }], schema);
                    currentQuizQuestions = JSON.parse(jsonString);
                    displayQuizQuestions();
                } catch (error) {
                    console.error("Error generating quiz:", error);
                    quizContent.innerHTML = `<p class="text-red-500">${translations[currentLang].apiError}</p>`;
                }
            }

            function displayQuizQuestions() {
                quizContent.innerHTML = '';
                quizResult.innerHTML = '';
                quizCheckBtn.disabled = false;
                quizCheckBtn.textContent = translations[currentLang].quizCheckBtn;

                currentQuizQuestions.forEach((item, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.innerHTML = `<p class="font-semibold">${index + 1}. ${item.q}</p>`;
                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = 'flex flex-col space-y-2 mt-2';
                    
                    item.o.forEach((option, optionIndex) => {
                        const label = document.createElement('label');
                        label.className = 'flex items-center space-x-3 p-2 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors';
                        label.innerHTML = `
                            <input type="radio" name="question-${index}" value="${optionIndex}" class="form-radio text-sky-500">
                            <span>${option}</span>
                        `;
                        optionsDiv.appendChild(label);
                    });
                    questionDiv.appendChild(optionsDiv);
                    quizContent.appendChild(questionDiv);
                });
            }

            function checkQuizAnswers() {
                let allCorrect = true;

                currentQuizQuestions.forEach((item, index) => {
                    const selected = document.querySelector(`input[name="question-${index}"]:checked`);
                    const labels = document.querySelectorAll(`input[name="question-${index}"]`);
                    
                    labels.forEach(label => {
                        label.parentElement.classList.remove('bg-red-100', 'bg-green-100');
                    });

                    if (selected && parseInt(selected.value) === item.a) {
                        selected.parentElement.classList.add('bg-green-100');
                    } else {
                        allCorrect = false;
                        if (selected) {
                            selected.parentElement.classList.add('bg-red-100');
                        }
                    }
                });

                if (allCorrect) {
                    quizResult.textContent = translations[currentLang].quizResultCorrect;
                    quizResult.className = 'mt-4 font-bold text-green-600';
                } else {
                    quizResult.textContent = translations[currentLang].quizResultIncorrect;
                    quizResult.className = 'mt-4 font-bold text-red-600';
                }
                quizCheckBtn.disabled = true;
            }

            // --- EVENT HANDLERS ---
            function handleScientistChange(e) {
                currentScientist = e.target.value;
                initialMessage.classList.add('hidden');
                messagesDiv.innerHTML = '';
                chatHistory = [];
                pendingImageOfferUrl = null;

                if (currentScientist === 'conclusion') {
                    chatContainer.classList.add('hidden');
                    conclusionContainer.classList.remove('hidden');
                } else if (currentScientist) {
                    conclusionContainer.classList.add('hidden');
                    chatContainer.classList.remove('hidden');
                    
                    loadingDiv.classList.remove('hidden');
                    
                    try {
                        const introPrompt = scientistData[currentScientist].introPrompt[currentLang];
                        const introText = callGemini([{ role: "user", parts: [{ text: introPrompt }] }]);
                        
                        introText.then(text => {
                            if(text) {
                                displayMessage(text, 'ai');
                            } else {
                                displayMessage("Hola! Estic a punt per parlar.", 'ai');
                            }

                            const persona = scientistData[currentScientist].persona[currentLang];
                            const systemPrompt = `${persona}. Les teves respostes sempre han de ser en ${currentLang === 'ca' ? 'catal√†' : 'espa√±ol'}, en primera persona. Ara, l'usuari far√† la seva primera pregunta.`;
                            
                            chatHistory.push({ role: "user", parts: [{ text: systemPrompt }] });
                            chatHistory.push({ role: "model", parts: [{ text: `Entesos. Estic preparat.` }] });
                        }).finally(() => {
                             loadingDiv.classList.add('hidden');
                        });
                    } catch (error) {
                        console.error("Error generating intro:", error);
                        displayMessage(translations[currentLang].apiError, 'ai');
                        loadingDiv.classList.add('hidden');
                    }

                } else {
                    chatContainer.classList.add('hidden');
                    conclusionContainer.classList.add('hidden');
                    initialMessage.classList.remove('hidden');
                    getInitialGreeting();
                }
            }

            async function handleFormSubmit(e) {
                e.preventDefault();
                const userText = chatInput.value.trim();
                if (!userText || !currentScientist) return;

                displayMessage(userText, 'user');
                chatInput.value = '';
                
                const isAffirmative = /^(s√≠|si|yes|ok|vale|d'acord|mostra)/i.test(userText);

                if (pendingImageOfferUrl && isAffirmative) {
                    displayImage(pendingImageOfferUrl);
                    pendingImageOfferUrl = null; // Clear the offer
                    return; // Don't call the API
                }
                
                pendingImageOfferUrl = null;

                loadingDiv.classList.remove('hidden');
                chatInput.disabled = true;
                sendButton.disabled = true;

                try {
                    chatHistory.push({ role: "user", parts: [{ text: userText }] });
                    const aiText = await callGemini(chatHistory);
                    
                    if (aiText) {
                        processAndDisplayAiResponse(aiText);
                        chatHistory.push({ role: "model", parts: [{ text: aiText }] });
                    } else {
                        displayMessage(translations[currentLang].apiEmptyResponse, 'ai');
                    }
                } catch (error) {
                    console.error("Error in chat flow:", error);
                    displayMessage(translations[currentLang].apiError, 'ai');
                } finally {
                    loadingDiv.classList.add('hidden');
                    chatInput.disabled = false;
                    sendButton.disabled = false;
                    chatInput.focus();
                }
            }
            
            async function getInitialGreeting() {
                initialLoading.classList.remove('hidden');
                initialContent.classList.add('hidden');
                try {
                    const prompt = translations[currentLang].initialGreetingPrompt;
                    const greetingText = await callGemini([{ role: "user", parts: [{ text: prompt }] }]);
                    initialTextContainer.innerHTML = markdownConverter.makeHtml(greetingText || "Benvingut!");
                } catch (error) {
                    console.error("Error getting initial greeting:", error);
                    initialTextContainer.textContent = "Benvingut! Tria un cient√≠fic per comen√ßar.";
                } finally {
                    initialLoading.classList.add('hidden');
                    initialContent.classList.remove('hidden');
                }
            }

            function toggleFullscreen() {
                if (!document.fullscreenElement) {
                    mainContainer.requestFullscreen().catch(err => console.error(`Fullscreen error: ${err.message}`));
                } else {
                    document.exitFullscreen();
                }
            }

            function detectLanguage() {
                const browserLang = navigator.language || navigator.userLanguage;
                setLanguage(browserLang.startsWith('es') ? 'es' : 'ca');
            }
            
            // --- INITIALIZATION ---
            detectLanguage();
            scientistSelect.addEventListener('change', handleScientistChange);
            chatForm.addEventListener('submit', handleFormSubmit);
            langCaButton.addEventListener('click', () => setLanguage('ca'));
            langEsButton.addEventListener('click', () => setLanguage('es'));
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            document.addEventListener('fullscreenchange', () => {
                fullscreenIcon.classList.toggle('hidden');
                minimizeIcon.classList.toggle('hidden');
            });
            quizBtn.addEventListener('click', openQuizModal);
            quizCloseBtn.addEventListener('click', () => quizModal.classList.add('hidden'));
            quizCheckBtn.addEventListener('click', checkQuizAnswers);
        });
    </script>
</body>
</html>
